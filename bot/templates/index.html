<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-i18n="app.title">Система публикации постов</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        :root {
            --primary-color: #6366f1;
            --primary-dark: #4f46e5;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --danger-color: #ef4444;
            --info-color: #06b6d4;
            --bg-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --bg-gradient-light: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            --card-shadow: 0 10px 25px rgba(0,0,0,0.1);
            --card-shadow-hover: 0 15px 35px rgba(0,0,0,0.15);
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --border-color: #e2e8f0;
            --bg-color: #ffffff;
            --bg-secondary: #f8fafc;
        }

        /* Темная тема */
        [data-theme="dark"] {
            --bg-gradient-light: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            --text-primary: #f8fafc;
            --text-secondary: #cbd5e1;
            --border-color: #475569;
            --bg-color: #1e293b;
            --bg-secondary: #0f172a;
            --card-shadow: 0 10px 25px rgba(0,0,0,0.5);
            --card-shadow-hover: 0 15px 35px rgba(0,0,0,0.6);
        }

        [data-theme="dark"] body {
            background: var(--bg-gradient-light);
        }

        [data-theme="dark"] body::before {
            opacity: 0.15;
        }

        [data-theme="dark"] .card,
        [data-theme="dark"] .status-card {
            background: #1e293b;
            color: var(--text-primary);
            border: 1px solid #334155;
        }

        [data-theme="dark"] .card-header {
            border-bottom: 1px solid #334155;
            background: #1e293b;
        }

        [data-theme="dark"] .group-item {
            background: #1e293b;
            border-left-color: var(--primary-color);
            border: 1px solid #334155;
        }

        [data-theme="dark"] .group-item:hover {
            background: #334155;
            border-color: var(--primary-color);
        }

        [data-theme="dark"] .form-control,
        [data-theme="dark"] .form-select {
            background: #334155;
            border-color: #475569;
            color: var(--text-primary);
        }

        [data-theme="dark"] .form-control:focus,
        [data-theme="dark"] .form-select:focus {
            background: #475569;
            border-color: var(--primary-color);
            color: var(--text-primary);
        }

        [data-theme="dark"] .form-control::placeholder {
            color: #94a3b8;
        }

        [data-theme="dark"] .empty-state {
            color: var(--text-secondary);
        }

        [data-theme="dark"] .empty-state i {
            color: var(--text-secondary);
            opacity: 0.6;
        }

        [data-theme="dark"] .list-group-item-danger {
            background: #7f1d1d;
            border-color: #991b1b;
        }

        [data-theme="dark"] .toast {
            background: #1e293b;
            color: var(--text-primary);
            border: 1px solid #334155;
        }

        [data-theme="dark"] .toast-body {
            background: #1e293b;
            color: var(--text-primary);
        }

        [data-theme="dark"] .navbar {
            background: var(--bg-gradient) !important;
        }

        [data-theme="dark"] .badge {
            box-shadow: 0 2px 8px rgba(0,0,0,0.4);
        }

        [data-theme="dark"] .text-muted {
            color: var(--text-secondary) !important;
        }

        [data-theme="dark"] .status-card h5 {
            color: var(--text-secondary);
        }

        [data-theme="dark"] .status-card h3 {
            color: var(--text-primary);
        }

        [data-theme="dark"] .status-card small {
            color: var(--text-secondary);
        }

        [data-theme="dark"] .btn-outline-primary {
            border-color: var(--primary-color);
            color: var(--primary-color);
        }

        [data-theme="dark"] .btn-outline-primary:hover {
            background: var(--primary-color);
            color: white;
        }

        [data-theme="dark"] .btn-outline-danger {
            border-color: var(--danger-color);
            color: var(--danger-color);
        }

        [data-theme="dark"] .btn-outline-danger:hover {
            background: var(--danger-color);
            color: white;
        }

        [data-theme="dark"] .progress {
            background: #334155;
        }

        [data-theme="dark"] .card-body {
            color: var(--text-primary);
        }

        [data-theme="dark"] .card-body h6 {
            color: var(--text-primary);
        }

        [data-theme="dark"] .card-body p {
            color: var(--text-primary);
        }

        [data-theme="dark"] .group-item h6 {
            color: var(--text-primary);
        }

        [data-theme="dark"] .group-item small {
            color: var(--text-secondary);
        }

        /* Переключатель темы */
        .theme-switcher {
            position: relative;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            margin: 0 10px;
        }

        .theme-switcher-toggle {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 26px;
        }

        .theme-switcher input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .theme-switcher-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(255, 255, 255, 0.3);
            transition: 0.4s;
            border-radius: 26px;
        }

        .theme-switcher-slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: 0.4s;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        input:checked + .theme-switcher-slider {
            background-color: rgba(255, 255, 255, 0.5);
        }

        input:checked + .theme-switcher-slider:before {
            transform: translateX(24px);
        }

        .theme-icon {
            font-size: 1.1rem;
            opacity: 0.8;
        }

        /* Переключатель языка */
        .language-switcher {
            display: inline-flex;
            gap: 5px;
            margin-left: 10px;
        }

        .language-switcher button {
            padding: 4px 10px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            background: transparent;
            color: white;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .language-switcher button:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .language-switcher button.active {
            background: rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.5);
        }

        [data-theme="dark"] .language-switcher button {
            border-color: rgba(255, 255, 255, 0.2);
        }

        [data-theme="dark"] .language-switcher button.active {
            background: rgba(255, 255, 255, 0.2);
        }

        * {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }

        body {
            background: var(--bg-gradient-light);
            min-height: 100vh;
            padding-bottom: 2rem;
            position: relative;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 400px;
            background: var(--bg-gradient);
            opacity: 0.05;
            z-index: 0;
            pointer-events: none;
        }

        .container {
            position: relative;
            z-index: 1;
        }

        /* Навигация */
        .navbar {
            background: var(--bg-gradient) !important;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            padding: 1rem 0;
        }

        .navbar-brand {
            font-weight: 700;
            font-size: 1.5rem;
            letter-spacing: -0.5px;
        }

        .navbar-text {
            font-weight: 500;
            font-size: 0.95rem;
        }

        /* Карточки статуса */
        .status-card {
            border: none;
            border-radius: 16px;
            box-shadow: var(--card-shadow);
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            overflow: hidden;
            position: relative;
            background: white;
            height: 100%;
        }

        .status-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--bg-gradient);
            transform: scaleX(0);
            transition: transform 0.3s ease;
        }

        .status-card:hover {
            transform: translateY(-8px);
            box-shadow: var(--card-shadow-hover);
        }

        .status-card:hover::before {
            transform: scaleX(1);
        }

        .status-card .card-body {
            padding: 1.75rem;
        }

        /* Улучшенные карточки статуса - разные цвета для разных типов */
        .status-card:nth-child(1) i {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .status-card:nth-child(2) i {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .status-card:nth-child(3) i {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .status-card:nth-child(4) i {
            background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .status-card i {
            font-size: 2.5rem;
            margin-bottom: 1rem;
        }

        .status-card h5 {
            font-weight: 600;
            color: var(--text-secondary);
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 0.75rem;
        }

        .status-card h3 {
            font-weight: 700;
            font-size: 2.25rem;
            margin: 0;
            background: var(--bg-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            line-height: 1.2;
        }

        /* Разные цвета для разных статусов */
        .status-card:nth-child(1) h3 {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .status-card:nth-child(2) h3 {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        /* Улучшенные бейджи в карточках статуса */
        .status-card .badge {
            font-size: 0.875rem;
            padding: 0.5rem 1rem;
            margin-top: 0.5rem;
            display: inline-block;
        }

        .status-card small {
            display: block;
            color: var(--text-secondary);
            font-size: 0.75rem;
            margin-top: 0.5rem;
            font-weight: 500;
        }

        /* Статус Telegram */
        .telegram-status {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
            box-shadow: 0 0 8px currentColor;
            animation: pulse 2s infinite;
        }

        .telegram-connected {
            background-color: var(--success-color);
            color: var(--success-color);
        }

        .telegram-disconnected {
            background-color: var(--danger-color);
            color: var(--danger-color);
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Карточки действий */
        .card {
            border: none;
            border-radius: 16px;
            box-shadow: var(--card-shadow);
            transition: all 0.3s ease;
            margin-bottom: 1.5rem;
            background: white;
            overflow: hidden;
        }

        .card:hover {
            box-shadow: var(--card-shadow-hover);
            transform: translateY(-2px);
        }

        .card-header {
            background: var(--bg-gradient);
            color: white;
            border: none;
            padding: 1.25rem 1.5rem;
            font-weight: 600;
            border-radius: 16px 16px 0 0 !important;
            position: relative;
        }

        .card-header::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: rgba(255, 255, 255, 0.2);
        }

        .card-header h5 {
            margin: 0;
            font-weight: 600;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
        }

        .card-header i {
            margin-right: 0.5rem;
            opacity: 0.9;
        }

        .card-body {
            padding: 1.5rem;
        }

        /* Кнопки */
        .btn {
            border-radius: 10px;
            font-weight: 500;
            padding: 0.625rem 1.25rem;
            transition: all 0.3s ease;
            border: none;
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .btn:hover::before {
            width: 300px;
            height: 300px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
            box-shadow: 0 4px 15px rgba(99, 102, 241, 0.4);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(99, 102, 241, 0.6);
        }

        .btn-success {
            background: linear-gradient(135deg, var(--success-color) 0%, #059669 100%);
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.4);
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(16, 185, 129, 0.6);
        }

        .btn-warning {
            background: linear-gradient(135deg, var(--warning-color) 0%, #d97706 100%);
            box-shadow: 0 4px 15px rgba(245, 158, 11, 0.4);
        }

        .btn-warning:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(245, 158, 11, 0.6);
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--danger-color) 0%, #dc2626 100%);
            box-shadow: 0 4px 15px rgba(239, 68, 68, 0.4);
        }

        .btn-info {
            background: linear-gradient(135deg, var(--info-color) 0%, #0891b2 100%);
            box-shadow: 0 4px 15px rgba(6, 182, 212, 0.4);
        }

        .btn-outline-primary {
            border: 2px solid var(--primary-color);
            color: var(--primary-color);
            background: transparent;
        }

        .btn-outline-primary:hover {
            background: var(--primary-color);
            color: white;
            transform: translateY(-2px);
        }

        .btn-outline-danger {
            border: 2px solid var(--danger-color);
            color: var(--danger-color);
            background: transparent;
        }

        .btn-outline-danger:hover {
            background: var(--danger-color);
            color: white;
            transform: translateY(-2px);
        }

        /* Бейджи */
        .badge {
            padding: 0.5rem 1.25rem;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }

        .badge.bg-success {
            background: linear-gradient(135deg, var(--success-color) 0%, #059669 100%) !important;
        }

        .badge.bg-warning {
            background: linear-gradient(135deg, var(--warning-color) 0%, #d97706 100%) !important;
        }

        .badge.bg-secondary {
            background: linear-gradient(135deg, #64748b 0%, #475569 100%) !important;
        }

        .badge.bg-primary {
            background: var(--bg-gradient) !important;
        }

        /* Группы */
        .group-item.disabled-group {
            opacity: 0.6;
            border-left-color: var(--danger-color);
        }

        .group-item.disabled-group h6 {
            color: var(--text-secondary);
        }

        .group-item {
            border-left: 4px solid var(--primary-color);
            border-radius: 12px;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            background: white;
            margin-bottom: 0.75rem;
            padding: 1.25rem;
            position: relative;
            overflow: hidden;
        }

        .group-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: var(--bg-gradient);
            transform: scaleY(0);
            transition: transform 0.3s ease;
        }

        .group-item:hover {
            border-left-color: var(--primary-dark);
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            transform: translateX(4px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .group-item:hover::before {
            transform: scaleY(1);
        }

        .group-item h6 {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.75rem;
            display: flex;
            align-items: center;
        }

        .group-item h6 i {
            margin-right: 0.5rem;
        }

        /* Прогресс-бар */
        .progress {
            height: 12px;
            border-radius: 10px;
            background: #e2e8f0;
            overflow: hidden;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
        }

        .progress-bar {
            border-radius: 10px;
            transition: width 0.6s ease;
            background: var(--bg-gradient);
            box-shadow: 0 2px 8px rgba(99, 102, 241, 0.4);
        }

        /* Формы */
        .form-control, .form-select {
            border-radius: 10px;
            border: 2px solid var(--border-color);
            padding: 0.75rem 1rem;
            transition: all 0.3s ease;
            font-size: 0.95rem;
        }

        .form-control:focus, .form-select:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
            outline: none;
        }

        .form-label {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.75rem;
            display: flex;
            align-items: center;
        }

        /* Улучшенный инпут-групп */
        .input-group {
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            border-radius: 10px;
            overflow: hidden;
        }

        .input-group .form-control {
            border-right: none;
        }

        .input-group .form-select {
            border-left: none;
            border-right: none;
        }

        .input-group .btn {
            border-left: none;
            border-radius: 0 10px 10px 0;
        }

        /* Улучшенный Toast */
        .toast {
            border-radius: 12px;
            box-shadow: var(--card-shadow);
            border: none;
            min-width: 300px;
        }

        .toast-header {
            background: var(--bg-gradient);
            color: white;
            border: none;
            border-radius: 12px 12px 0 0;
            font-weight: 600;
        }

        .toast-header .btn-close {
            filter: invert(1);
            opacity: 0.8;
        }

        .toast-header .btn-close:hover {
            opacity: 1;
        }

        .toast-body {
            padding: 1rem 1.25rem;
            font-size: 0.95rem;
        }

        /* Улучшенная панель статуса публикации */
        #publicationStatusPanel {
            animation: slideDown 0.4s ease;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        
        #publicationStatusPanel[style*="display: none"] {
            display: none !important;
        }
        
        #publicationStatusPanel[style*="display: block"] {
            display: block !important;
        }

        #publicationStatusPanel .card-header {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        }

        #publicationStatusPanel h6 {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
        }

        #publicationStatusPanel p {
            font-size: 1rem;
            color: var(--text-primary);
            margin-bottom: 0;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Контейнер */
        .container {
            max-width: 1400px;
            position: relative;
            z-index: 1;
        }

        /* Загрузка */
        .spinner-border-sm {
            width: 1rem;
            height: 1rem;
            border-width: 0.15em;
        }

        /* Адаптивность */
        @media (max-width: 768px) {
            .status-card h3 {
                font-size: 1.75rem;
            }

            .status-card i {
                font-size: 2rem;
            }

            .navbar-brand {
                font-size: 1.25rem;
            }

            .card-body {
                padding: 1.25rem;
            }

            .group-item {
                padding: 1rem;
            }

            .btn-group {
                flex-direction: column;
            }

            .btn-group .btn {
                border-radius: 10px !important;
                margin-bottom: 0.5rem;
            }
        }

        @media (max-width: 576px) {
            .status-card .card-body {
                padding: 1.25rem;
            }

            .status-card h3 {
                font-size: 1.5rem;
            }
        }

        /* Анимация появления */
        /* Telegram-подобный предпросмотр */
        .telegram-preview-container {
            background: var(--bg-color);
            border-radius: 12px;
            padding: 16px;
            border: 1px solid var(--border-color);
            max-width: 500px;
            margin: 0 auto;
        }

        [data-theme="dark"] .telegram-preview-container {
            background: #1e1e1e;
            border-color: #333;
        }

        .telegram-message {
            background: var(--card-bg);
            border-radius: 8px;
            padding: 12px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        [data-theme="dark"] .telegram-message {
            background: #2b2b2b;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .telegram-message-header {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
        }

        .telegram-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 24px;
            margin-right: 10px;
        }

        .telegram-message-info {
            flex: 1;
        }

        .telegram-author {
            font-weight: 600;
            color: var(--text-primary);
            display: block;
            font-size: 15px;
        }

        .telegram-time {
            font-size: 12px;
            color: var(--text-secondary);
            margin-left: 8px;
        }

        .telegram-message-content {
            margin-top: 4px;
        }

        .telegram-text {
            color: var(--text-primary);
            line-height: 1.5;
            white-space: pre-wrap;
            word-wrap: break-word;
            font-size: 15px;
        }

        .telegram-text strong {
            font-weight: 600;
        }

        .telegram-text em {
            font-style: italic;
        }

        .telegram-text code {
            background: var(--bg-color);
            padding: 2px 4px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
        }

        .telegram-text a {
            color: #0088cc;
            text-decoration: none;
        }

        .telegram-text a:hover {
            text-decoration: underline;
        }

        .telegram-image {
            margin-top: 12px;
            border-radius: 8px;
            overflow: hidden;
        }

        .telegram-image img {
            width: 100%;
            height: auto;
            display: block;
        }

        .telegram-image img[style*="display: none"] {
            display: none !important;
        }

        .fade-in {
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* Улучшенные списки */
        .list-group-item {
            border-radius: 10px;
            margin-bottom: 0.5rem;
            border: none;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            transition: all 0.3s ease;
        }

        .list-group-item:hover {
            transform: translateX(4px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .list-group-item-danger {
            border-left: 4px solid var(--danger-color);
            background: #fef2f2;
        }

        .list-group-item-danger h6 {
            color: var(--danger-color);
        }

        /* Пустые состояния */
        .empty-state {
            text-align: center;
            padding: 3rem 1rem;
            color: var(--text-secondary);
        }

        .empty-state i {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        .empty-state p {
            font-size: 1.1rem;
            font-weight: 500;
            margin-bottom: 0.5rem;
        }

        .empty-state small {
            font-size: 0.875rem;
            opacity: 0.7;
        }
    </style>
</head>
<body class="bg-light">
    <nav class="navbar navbar-dark">
        <div class="container">
            <span class="navbar-brand mb-0">
                <i class="fas fa-rocket me-2"></i>
                <span data-i18n="app.title">Система публикации постов</span>
            </span>
            <div class="navbar-nav d-flex flex-row align-items-center">
                <div class="language-switcher">
                    <button onclick="setLanguage('ru')" id="lang-ru" class="active">RU</button>
                    <button onclick="setLanguage('en')" id="lang-en">EN</button>
                </div>
                <div class="theme-switcher">
                    <i class="fas fa-sun theme-icon" id="themeIcon"></i>
                    <label class="theme-switcher-toggle">
                        <input type="checkbox" id="themeToggle" onchange="toggleTheme()">
                        <span class="theme-switcher-slider"></span>
                    </label>
                </div>
                <button class="btn btn-sm btn-outline-light ms-3" onclick="logout()" title="Выйти">
                    <i class="fas fa-sign-out-alt me-1"></i> Выход
                </button>
                <span class="navbar-text ms-3">
                    <span class="telegram-status" id="telegramStatus"></span>
                    <span id="telegramStatusText" data-i18n="connection.checking">Проверка подключения...</span>
                </span>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- Статус системы -->
        <div class="row mb-4">
            <div class="col-md-3 col-sm-6 mb-3">
                <div class="card status-card fade-in">
                    <div class="card-body text-center">
                        <i class="fas fa-users"></i>
                        <h5 data-i18n="status.groups">Группы</h5>
                        <h3 class="text-primary" id="groupsCount">-</h3>
                    </div>
                </div>
            </div>
            <div class="col-md-3 col-sm-6 mb-3">
                <div class="card status-card fade-in">
                    <div class="card-body text-center">
                        <i class="fas fa-clock"></i>
                        <h5 data-i18n="status.interval">Интервал</h5>
                        <h3 class="text-success" id="interval">-</h3>
                    </div>
                </div>
            </div>
            <div class="col-md-3 col-sm-6 mb-3">
                <div class="card status-card fade-in">
                    <div class="card-body text-center">
                        <i class="fas fa-cogs"></i>
                        <h5 data-i18n="status.scheduler">Планировщик</h5>
                        <span class="badge" id="schedulerStatus">-</span>
                    </div>
                </div>
            </div>
            <div class="col-md-3 col-sm-6 mb-3">
                <div class="card status-card fade-in">
                    <div class="card-body text-center">
                        <i class="fas fa-calendar-alt"></i>
                        <h5 data-i18n="status.nextPublication">Следующая публикация</h5>
                        <small id="nextRun" class="text-muted fw-semibold">-</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3 col-sm-6 mb-3">
                <div class="card status-card fade-in">
                    <div class="card-body text-center">
                        <i class="fas fa-paper-plane"></i>
                        <h5 data-i18n="status.publication">Статус публикации</h5>
                        <span class="badge bg-secondary" id="publicationStatus">-</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Статус публикации -->
        <div class="row mb-4" id="publicationStatusPanel" style="display: none;">
            <div class="col-12">
                <div class="card fade-in">
                    <div class="card-header">
                        <h5><i class="fas fa-tasks me-2"></i><span data-i18n="publication.details">Детальный статус публикации</span></h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <h6 class="fw-bold text-muted mb-2"><i class="fas fa-list-ul me-2"></i><span data-i18n="publication.currentStep">Текущий этап:</span></h6>
                                <p id="currentStep" class="fw-semibold">-</p>
                                
                                <h6 class="fw-bold text-muted mb-2 mt-3"><i class="fas fa-chart-line me-2"></i><span data-i18n="publication.progress">Прогресс:</span></h6>
                                <div class="progress mb-2">
                                    <div class="progress-bar" id="progressBar" role="progressbar" style="width: 0%"></div>
                                </div>
                                <small id="progressText" class="text-muted fw-semibold">0% (0/0)</small>
                            </div>
                            <div class="col-md-6 mb-3">
                                <h6 class="fw-bold text-muted mb-2"><i class="fas fa-play-circle me-2"></i><span data-i18n="publication.startTime">Время начала:</span></h6>
                                <p id="startTime" class="fw-semibold">-</p>
                                
                                <h6 class="fw-bold text-muted mb-2 mt-3"><i class="fas fa-clock me-2"></i><span data-i18n="publication.lastUpdate">Последнее обновление:</span></h6>
                                <p id="lastUpdate" class="fw-semibold">-</p>
                            </div>
                        </div>
                        
                        <div id="errorsSection" style="display: none;">
                            <hr>
                            <h6 class="fw-bold text-danger mb-3"><i class="fas fa-exclamation-triangle me-2"></i><span data-i18n="publication.errors">Ошибки:</span></h6>
                            <div id="errorsList" class="list-group"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Управление -->
        <div class="row mb-4">
            <div class="col-md-6 mb-3">
                <div class="card fade-in">
                    <div class="card-header">
                        <h5><i class="fas fa-bolt me-2"></i><span data-i18n="actions.quick">Быстрые действия</span></h5>
                    </div>
                    <div class="card-body">
                        <div class="d-grid gap-2">
                            <button class="btn btn-success btn-loading" id="postNowBtn">
                                <i class="fas fa-paper-plane me-2"></i><span data-i18n="actions.publishNow">Опубликовать сейчас</span>
                            </button>
                            <div class="btn-group" role="group">
                                <button class="btn btn-primary btn-loading" id="startSchedulerBtn">
                                    <i class="fas fa-play me-2"></i><span data-i18n="actions.startScheduler">Запустить планировщик</span>
                                </button>
                                <button class="btn btn-warning btn-loading" id="stopSchedulerBtn">
                                    <i class="fas fa-stop me-2"></i><span data-i18n="actions.stop">Остановить</span>
                                </button>
                            </div>
                            <button class="btn btn-info btn-loading" id="reloadPostBtn">
                                <i class="fas fa-sync me-2"></i><span data-i18n="actions.reloadPost">Перезагрузить пост</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6 mb-3">
                <div class="card fade-in">
                    <div class="card-header">
                        <h5><i class="fas fa-sliders-h me-2"></i><span data-i18n="settings.title">Настройки</span></h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="intervalInput" class="form-label fw-semibold">
                                <i class="fas fa-clock me-2"></i><span data-i18n="settings.interval">Интервал публикации</span>
                            </label>
                            <div class="input-group">
                                <input type="number" class="form-control" id="intervalInput" min="1" max="10080" value="24" placeholder="Введите число">
                                <select class="form-select" id="intervalUnit" style="max-width: 120px;">
                                    <option value="minutes">мин</option>
                                    <option value="hours" selected>часов</option>
                                </select>
                                <button class="btn btn-primary" id="setIntervalBtn">
                                    <i class="fas fa-check me-2"></i><span data-i18n="settings.set">Установить</span>
                                </button>
                            </div>
                            <small class="form-text text-muted d-block mt-2">
                                <i class="fas fa-info-circle me-1"></i>
                                <span data-i18n="settings.maxMinutes">Максимум: 10080 минут (7 дней). Минимум: 1 минута.</span>
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Расписание публикаций -->
        <div class="row">
            <div class="col-12 mb-3">
                <div class="card fade-in">
                    <div class="card-header">
                        <h5><i class="fas fa-calendar-alt me-2"></i><span data-i18n="schedule.title">Расписание публикаций</span></h5>
                    </div>
                    <div class="card-body">
                        <!-- Кнопка создания расписания -->
                        <div class="mb-3">
                            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#scheduleModal">
                                <i class="fas fa-plus me-2"></i><span data-i18n="schedule.create">Создать расписание</span>
                            </button>
                        </div>
                        
                        <!-- Таблица расписаний -->
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th data-i18n="schedule.table.type">Тип</th>
                                        <th data-i18n="schedule.table.details">Детали</th>
                                        <th data-i18n="schedule.table.status">Статус</th>
                                        <th data-i18n="schedule.table.created">Создано</th>
                                        <th data-i18n="schedule.table.actions">Действия</th>
                                    </tr>
                                </thead>
                                <tbody id="schedulesList">
                                    <tr>
                                        <td colspan="5" class="text-center">
                                            <i class="fas fa-spinner fa-spin"></i> <span data-i18n="schedule.loading">Загрузка...</span>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Управление группами -->
        <div class="row">
            <div class="col-md-6 mb-3">
                <div class="card fade-in">
                    <div class="card-header">
                        <h5><i class="fas fa-plus-circle me-2"></i><span data-i18n="groups.add">Добавить группу/канал</span></h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="groupInput" class="form-label fw-semibold">
                                <i class="fas fa-link me-2"></i><span data-i18n="groups.input">Ссылка, @username или ID</span>
                            </label>
                            <input type="text" class="form-control" id="groupInput" 
                                   placeholder="@group_name, -1001234567890, https://t.me/group_name">
                        </div>
                        <button class="btn btn-primary btn-loading w-100" id="addGroupBtn">
                            <i class="fas fa-plus me-2"></i><span data-i18n="groups.addButton">Добавить группу</span>
                        </button>
                    </div>
                </div>
            </div>
            <div class="col-md-6 mb-3">
                <div class="card fade-in">
                    <div class="card-header">
                        <h5><i class="fas fa-list me-2"></i><span data-i18n="groups.list">Список групп/каналов</span></h5>
                    </div>
                    <div class="card-body">
                        <div id="groupsList">
                            <div class="empty-state">
                                <i class="fas fa-spinner fa-spin"></i>
                                <p data-i18n="groups.loading">Загрузка групп...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- История публикаций -->
        <div class="row">
            <div class="col-12 mb-3">
                <div class="card fade-in">
                    <div class="card-header">
                        <h5><i class="fas fa-history me-2"></i><span data-i18n="history.title">История публикаций</span></h5>
                    </div>
                    <div class="card-body">
                        <!-- Фильтры -->
                        <div class="row mb-3">
                            <div class="col-md-3">
                                <label class="form-label"><i class="fas fa-filter me-1"></i><span data-i18n="history.filters.status">Статус</span></label>
                                <select class="form-select" id="historyStatusFilter">
                                    <option value="">Все</option>
                                    <option value="success">Успешные</option>
                                    <option value="error">Ошибки</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label"><i class="fas fa-search me-1"></i><span data-i18n="history.filters.search">Поиск</span></label>
                                <input type="text" class="form-control" id="historySearchFilter" placeholder="Название группы...">
                            </div>
                            <div class="col-md-2">
                                <label class="form-label"><i class="fas fa-calendar me-1"></i><span data-i18n="history.filters.dateFrom">С даты</span></label>
                                <input type="date" class="form-control" id="historyDateFromFilter">
                            </div>
                            <div class="col-md-2">
                                <label class="form-label"><i class="fas fa-calendar me-1"></i><span data-i18n="history.filters.dateTo">По дату</span></label>
                                <input type="date" class="form-control" id="historyDateToFilter">
                            </div>
                            <div class="col-md-2 d-flex align-items-end">
                                <button class="btn btn-primary w-100" id="historyFilterBtn">
                                    <i class="fas fa-filter me-1"></i><span data-i18n="history.filters.apply">Применить</span>
                                </button>
                            </div>
                        </div>
                        
                        <!-- Таблица истории -->
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th data-i18n="history.table.time">Время</th>
                                        <th data-i18n="history.table.group">Группа</th>
                                        <th data-i18n="history.table.status">Статус</th>
                                        <th data-i18n="history.table.retries">Попытки</th>
                                        <th data-i18n="history.table.error">Ошибка</th>
                                    </tr>
                                </thead>
                                <tbody id="historyTableBody">
                                    <tr>
                                        <td colspan="5" class="text-center">
                                            <i class="fas fa-spinner fa-spin"></i> <span data-i18n="history.loading">Загрузка...</span>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- Пагинация -->
                        <div class="d-flex justify-content-between align-items-center mt-3">
                            <div>
                                <button class="btn btn-sm btn-outline-secondary" id="historyPrevBtn" disabled>
                                    <i class="fas fa-chevron-left"></i> <span data-i18n="history.prev">Назад</span>
                                </button>
                                <span class="mx-2" id="historyPageInfo">1 / 1</span>
                                <button class="btn btn-sm btn-outline-secondary" id="historyNextBtn" disabled>
                                    <span data-i18n="history.next">Вперед</span> <i class="fas fa-chevron-right"></i>
                                </button>
                            </div>
                            <button class="btn btn-sm btn-outline-danger" id="historyClearBtn">
                                <i class="fas fa-trash me-1"></i><span data-i18n="history.clear">Очистить историю</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Статистика -->
        <div class="row">
            <div class="col-12 mb-3">
                <div class="card fade-in">
                    <div class="card-header">
                        <h5><i class="fas fa-chart-bar me-2"></i><span data-i18n="statistics.title">Статистика публикаций</span></h5>
                    </div>
                    <div class="card-body">
                        <!-- Карточки статистики -->
                        <div class="row mb-4">
                            <div class="col-md-3 mb-3">
                                <div class="card bg-primary text-white">
                                    <div class="card-body">
                                        <h6 class="card-title"><i class="fas fa-file-alt me-2"></i><span data-i18n="statistics.total">Всего публикаций</span></h6>
                                        <h2 id="statTotal">0</h2>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3 mb-3">
                                <div class="card bg-success text-white">
                                    <div class="card-body">
                                        <h6 class="card-title"><i class="fas fa-check-circle me-2"></i><span data-i18n="statistics.successful">Успешных</span></h6>
                                        <h2 id="statSuccessful">0</h2>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3 mb-3">
                                <div class="card bg-danger text-white">
                                    <div class="card-body">
                                        <h6 class="card-title"><i class="fas fa-times-circle me-2"></i><span data-i18n="statistics.failed">Неудачных</span></h6>
                                        <h2 id="statFailed">0</h2>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3 mb-3">
                                <div class="card bg-info text-white">
                                    <div class="card-body">
                                        <h6 class="card-title"><i class="fas fa-percentage me-2"></i><span data-i18n="statistics.successRate">Процент успеха</span></h6>
                                        <h2 id="statSuccessRate">0%</h2>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Графики -->
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <div class="card">
                                    <div class="card-header">
                                        <h6><i class="fas fa-chart-line me-2"></i><span data-i18n="statistics.dailyActivity">Активность по дням</span></h6>
                                    </div>
                                    <div class="card-body">
                                        <canvas id="dailyChart"></canvas>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <div class="card">
                                    <div class="card-header">
                                        <h6><i class="fas fa-chart-pie me-2"></i><span data-i18n="statistics.successRate">Процент успеха</span></h6>
                                    </div>
                                    <div class="card-body">
                                        <canvas id="successRateChart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- График активности по часам и топ групп -->
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <div class="card">
                                    <div class="card-header">
                                        <h6><i class="fas fa-clock me-2"></i><span data-i18n="statistics.hourlyActivity">Активность по часам</span></h6>
                                    </div>
                                    <div class="card-body">
                                        <canvas id="hourlyChart"></canvas>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <div class="card">
                                    <div class="card-header">
                                        <h6><i class="fas fa-trophy me-2"></i><span data-i18n="statistics.topGroups">Топ групп</span></h6>
                                    </div>
                                    <div class="card-body">
                                        <canvas id="topGroupsChart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Фильтры дат для статистики -->
                        <div class="row mt-3">
                            <div class="col-md-4">
                                <label class="form-label"><i class="fas fa-calendar me-1"></i><span data-i18n="statistics.filterFrom">С даты</span></label>
                                <input type="date" class="form-control" id="statDateFrom">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label"><i class="fas fa-calendar me-1"></i><span data-i18n="statistics.filterTo">По дату</span></label>
                                <input type="date" class="form-control" id="statDateTo">
                            </div>
                            <div class="col-md-4 d-flex align-items-end">
                                <button class="btn btn-primary w-100" id="statFilterBtn">
                                    <i class="fas fa-filter me-1"></i><span data-i18n="statistics.filterApply">Применить</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Шаблоны постов -->
        <div class="row">
            <div class="col-12 mb-3">
                <div class="card fade-in">
                    <div class="card-header">
                        <h5><i class="fas fa-file-alt me-2"></i><span data-i18n="templates.title">Шаблоны постов</span></h5>
                    </div>
                    <div class="card-body">
                        <!-- Кнопка создания шаблона -->
                        <div class="mb-3">
                            <button class="btn btn-primary" id="createTemplateBtn" data-bs-toggle="modal" data-bs-target="#templateModal">
                                <i class="fas fa-plus me-2"></i><span data-i18n="templates.create">Создать шаблон</span>
                            </button>
                        </div>

                        <!-- Список шаблонов -->
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th data-i18n="templates.table.name">Название</th>
                                        <th data-i18n="templates.table.content">Содержимое</th>
                                        <th data-i18n="templates.table.status">Статус</th>
                                        <th data-i18n="templates.table.actions">Действия</th>
                                    </tr>
                                </thead>
                                <tbody id="templatesTableBody">
                                    <tr>
                                        <td colspan="4" class="text-center">
                                            <i class="fas fa-spinner fa-spin"></i> <span data-i18n="templates.loading">Загрузка...</span>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <!-- Информация о переменных -->
                        <div class="alert alert-info mt-3">
                            <h6><i class="fas fa-info-circle me-2"></i><span data-i18n="templates.variables.title">Доступные переменные:</span></h6>
                            <ul class="mb-0">
                                <li><code>{date}</code> - <span data-i18n="templates.variables.date">текущая дата</span></li>
                                <li><code>{time}</code> - <span data-i18n="templates.variables.time">текущее время</span></li>
                                <li><code>{datetime}</code> - <span data-i18n="templates.variables.datetime">дата и время</span></li>
                                <li><code>{chat_id}</code> - <span data-i18n="templates.variables.chatId">ID чата</span></li>
                                <li><code>{chat_title}</code> - <span data-i18n="templates.variables.chatTitle">название чата</span></li>
                                <li><code>{random_number}</code> - <span data-i18n="templates.variables.random">случайное число (1-1000)</span></li>
                                <li><code>{random_number:min:max}</code> - <span data-i18n="templates.variables.randomRange">случайное число от min до max</span></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Предпросмотр поста -->
        <div class="row">
            <div class="col-12 mb-3">
                <div class="card fade-in">
                    <div class="card-header">
                        <h5><i class="fas fa-eye me-2"></i><span data-i18n="preview.title">Предпросмотр поста</span></h5>
                    </div>
                    <div class="card-body">
                        <!-- Выбор группы для предпросмотра -->
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="previewChatSelect" class="form-label"><span data-i18n="preview.selectGroup">Выберите группу для предпросмотра:</span></label>
                                <select class="form-select" id="previewChatSelect">
                                    <option value="" data-i18n="preview.testGroup">Тестовая группа</option>
                                </select>
                            </div>
                            <div class="col-md-6 d-flex align-items-end">
                                <button class="btn btn-primary" id="updatePreviewBtn">
                                    <i class="fas fa-sync me-1"></i><span data-i18n="preview.update">Обновить предпросмотр</span>
                                </button>
                            </div>
                        </div>

                        <!-- Telegram-подобный предпросмотр -->
                        <div class="telegram-preview-container">
                            <div class="telegram-message">
                                <div class="telegram-message-header">
                                    <div class="telegram-avatar">
                                        <i class="fas fa-user-circle"></i>
                                    </div>
                                    <div class="telegram-message-info">
                                        <span class="telegram-author" data-i18n="preview.author">Вы</span>
                                        <span class="telegram-time" id="previewTime"></span>
                                    </div>
                                </div>
                                <div class="telegram-message-content">
                                    <div class="telegram-text" id="previewText">
                                        <i class="fas fa-spinner fa-spin"></i> <span data-i18n="preview.loading">Загрузка...</span>
                                    </div>
                                    <div class="telegram-image" id="previewImage" style="display: none;">
                                        <img id="previewImageElement" src="" alt="" style="display: none;" />
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Информация о посте -->
                        <div class="mt-3">
                            <small class="text-muted">
                                <span data-i18n="preview.info">Длина текста:</span> <span id="previewTextLength">0</span> <span data-i18n="preview.chars">символов</span>
                                <span class="ms-3" id="previewTemplateInfo" style="display: none;">
                                    <i class="fas fa-file-alt me-1"></i><span data-i18n="preview.usingTemplate">Используется шаблон:</span> <span id="previewTemplateName"></span>
                                </span>
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Модальное окно для создания/редактирования шаблона -->
    <div class="modal fade" id="templateModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="templateModalTitle" data-i18n="templates.create">Создать шаблон</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="templateForm">
                        <input type="hidden" id="templateId" value="">
                        <div class="mb-3">
                            <label for="templateName" class="form-label"><span data-i18n="templates.form.name">Название</span></label>
                            <input type="text" class="form-control" id="templateName" required>
                        </div>
                        <div class="mb-3">
                            <label for="templateContent" class="form-label"><span data-i18n="templates.form.content">Содержимое</span></label>
                            <textarea class="form-control" id="templateContent" rows="10" required></textarea>
                            <small class="form-text text-muted">
                                <span data-i18n="templates.form.variablesHint">Используйте переменные в фигурных скобках, например: {date}, {chat_title}</span>
                            </small>
                        </div>
                        <div class="mb-3">
                            <button type="button" class="btn btn-outline-secondary" id="previewTemplateBtn">
                                <i class="fas fa-eye me-1"></i><span data-i18n="templates.form.preview">Предпросмотр</span>
                            </button>
                        </div>
                        <div id="templatePreview" class="alert alert-light" style="display: none;">
                            <h6><span data-i18n="templates.form.previewTitle">Предпросмотр:</span></h6>
                            <pre id="templatePreviewContent" class="mb-0"></pre>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal"><span data-i18n="common.cancel">Отмена</span></button>
                    <button type="button" class="btn btn-primary" id="saveTemplateBtn"><span data-i18n="common.save">Сохранить</span></button>
                </div>
            </div>
        </div>
    </div>

    <!-- Модальное окно для создания/редактирования расписания -->
    <div class="modal fade" id="scheduleModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="scheduleModalTitle" data-i18n="schedule.create">Создать расписание</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="scheduleForm">
                        <input type="hidden" id="scheduleId" value="">
                        
                        <!-- Тип расписания -->
                        <div class="mb-3">
                            <label for="scheduleType" class="form-label"><span data-i18n="schedule.form.type">Тип расписания</span></label>
                            <select class="form-select" id="scheduleType" required>
                                <option value="interval" data-i18n="schedule.types.interval">Интервал</option>
                                <option value="time" data-i18n="schedule.types.time">Конкретное время</option>
                                <option value="days" data-i18n="schedule.types.days">Дни недели</option>
                                <option value="hours" data-i18n="schedule.types.hours">Часовое окно</option>
                            </select>
                        </div>
                        
                        <!-- Поля для интервала -->
                        <div id="scheduleIntervalFields" class="schedule-type-fields">
                            <div class="mb-3">
                                <label for="intervalMinutes" class="form-label"><span data-i18n="schedule.form.intervalMinutes">Интервал (минуты)</span></label>
                                <input type="number" class="form-control" id="intervalMinutes" min="1" max="10080" value="1440">
                            </div>
                        </div>
                        
                        <!-- Поля для конкретного времени -->
                        <div id="scheduleTimeFields" class="schedule-type-fields" style="display: none;">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="timeHour" class="form-label"><span data-i18n="schedule.form.hour">Час</span></label>
                                    <input type="number" class="form-control" id="timeHour" min="0" max="23" value="12">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="timeMinute" class="form-label"><span data-i18n="schedule.form.minute">Минута</span></label>
                                    <input type="number" class="form-control" id="timeMinute" min="0" max="59" value="0">
                                </div>
                            </div>
                        </div>
                        
                        <!-- Поля для дней недели -->
                        <div id="scheduleDaysFields" class="schedule-type-fields" style="display: none;">
                            <div class="mb-3">
                                <label class="form-label"><span data-i18n="schedule.form.days">Дни недели</span></label>
                                <div class="d-flex flex-wrap gap-2">
                                    <label class="btn btn-outline-primary">
                                        <input type="checkbox" class="schedule-day-checkbox" value="0"> <span data-i18n="schedule.days.mon">Пн</span>
                                    </label>
                                    <label class="btn btn-outline-primary">
                                        <input type="checkbox" class="schedule-day-checkbox" value="1"> <span data-i18n="schedule.days.tue">Вт</span>
                                    </label>
                                    <label class="btn btn-outline-primary">
                                        <input type="checkbox" class="schedule-day-checkbox" value="2"> <span data-i18n="schedule.days.wed">Ср</span>
                                    </label>
                                    <label class="btn btn-outline-primary">
                                        <input type="checkbox" class="schedule-day-checkbox" value="3"> <span data-i18n="schedule.days.thu">Чт</span>
                                    </label>
                                    <label class="btn btn-outline-primary">
                                        <input type="checkbox" class="schedule-day-checkbox" value="4"> <span data-i18n="schedule.days.fri">Пт</span>
                                    </label>
                                    <label class="btn btn-outline-primary">
                                        <input type="checkbox" class="schedule-day-checkbox" value="5"> <span data-i18n="schedule.days.sat">Сб</span>
                                    </label>
                                    <label class="btn btn-outline-primary">
                                        <input type="checkbox" class="schedule-day-checkbox" value="6"> <span data-i18n="schedule.days.sun">Вс</span>
                                    </label>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="daysHour" class="form-label"><span data-i18n="schedule.form.hour">Час</span></label>
                                    <input type="number" class="form-control" id="daysHour" min="0" max="23" value="12">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="daysMinute" class="form-label"><span data-i18n="schedule.form.minute">Минута</span></label>
                                    <input type="number" class="form-control" id="daysMinute" min="0" max="59" value="0">
                                </div>
                            </div>
                        </div>
                        
                        <!-- Поля для часового окна -->
                        <div id="scheduleHoursFields" class="schedule-type-fields" style="display: none;">
                            <div class="row">
                                <div class="col-md-4 mb-3">
                                    <label for="hoursStart" class="form-label"><span data-i18n="schedule.form.startHour">Начальный час</span></label>
                                    <input type="number" class="form-control" id="hoursStart" min="0" max="23" value="9">
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label for="hoursEnd" class="form-label"><span data-i18n="schedule.form.endHour">Конечный час</span></label>
                                    <input type="number" class="form-control" id="hoursEnd" min="0" max="23" value="18">
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label for="hoursInterval" class="form-label"><span data-i18n="schedule.form.intervalMinutes">Интервал (минуты)</span></label>
                                    <input type="number" class="form-control" id="hoursInterval" min="1" max="1440" value="60">
                                </div>
                            </div>
                        </div>
                        
                        <!-- Активировать сразу -->
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="scheduleActive">
                                <label class="form-check-label" for="scheduleActive">
                                    <span data-i18n="schedule.form.activate">Активировать сразу</span>
                                </label>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal"><span data-i18n="common.cancel">Отмена</span></button>
                    <button type="button" class="btn btn-primary" id="saveScheduleBtn"><span data-i18n="common.save">Сохранить</span></button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast для уведомлений -->
    <div class="toast-container position-fixed bottom-0 end-0 p-3">
        <div id="toast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-header">
                <i class="fas fa-info-circle me-2"></i>
                <strong class="me-auto" data-i18n="toast.notification">Уведомление</strong>
                <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
            <div class="toast-body" id="toastBody">
                <!-- Сообщение будет вставлено сюда -->
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Переводы
        const translations = {
            ru: {
                'app.title': 'Система публикации постов',
                'connection.checking': 'Проверка подключения...',
                'connection.connected': 'Подключен',
                'connection.disconnected': 'Отключен',
                'status.groups': 'Группы',
                'status.interval': 'Интервал',
                'status.scheduler': 'Планировщик',
                'status.nextPublication': 'Следующая публикация',
                'status.publication': 'Статус публикации',
                'status.running': 'Запущен',
                'status.stopped': 'Остановлен',
                'status.notActive': 'Неактивно',
                'status.publishing': 'Публикация',
                'status.waiting': 'Ожидание',
                'publication.details': 'Детальный статус публикации',
                'publication.currentStep': 'Текущий этап:',
                'publication.progress': 'Прогресс:',
                'publication.startTime': 'Время начала:',
                'publication.lastUpdate': 'Последнее обновление:',
                'publication.errors': 'Ошибки:',
                'actions.quick': 'Быстрые действия',
                'actions.publishNow': 'Опубликовать сейчас',
                'actions.startScheduler': 'Запустить планировщик',
                'actions.stop': 'Остановить',
                'actions.reloadPost': 'Перезагрузить пост',
                'settings.title': 'Настройки',
                'settings.interval': 'Интервал публикации',
                'settings.set': 'Установить',
                'settings.maxMinutes': 'Максимум: 10080 минут (7 дней). Минимум: 1 минута.',
                'groups.add': 'Добавить группу/канал',
                'groups.input': 'Ссылка, @username или ID',
                'groups.addButton': 'Добавить группу',
                'groups.list': 'Список групп/каналов',
                'groups.empty': 'Нет добавленных групп',
                'groups.emptyDesc': 'Добавьте группу или канал для начала работы',
                'groups.loading': 'Загрузка групп...',
                'groups.lastPost': 'Последняя публикация:',
                'groups.delete': 'Удалить группу',
                'groups.deleteConfirm': 'Удалить эту группу?',
                'groups.active': 'Активна',
                'groups.disabled': 'Отключена',
                'groups.enable': 'Включить группу',
                'groups.disable': 'Отключить группу',
                'groups.disabledSuccess': 'Группа отключена',
                'groups.enabledSuccess': 'Группа включена',
                'toast.notification': 'Уведомление',
                'toast.enterGroup': 'Введите ссылку, @username или ID группы',
                'toast.maxInterval': 'Максимальный интервал: 10080 минут (7 дней)',
                'toast.invalidInterval': 'Введите корректный интервал (больше 0)',
                'toast.unknownUnit': 'Неизвестная единица измерения',
                'toast.errorPublishing': 'Ошибка публикации',
                'toast.errorStartScheduler': 'Ошибка запуска планировщика',
                'toast.errorStopScheduler': 'Ошибка остановки планировщика',
                'toast.errorReloadPost': 'Ошибка перезагрузки поста',
                'toast.errorAddGroup': 'Ошибка добавления группы',
                'toast.errorToggleGroup': 'Ошибка изменения статуса группы',
                'toast.errorSetInterval': 'Ошибка установки интервала',
                'toast.groupNotFound': 'Не удалось найти чат. Проверьте, что чат существует и ваша учетная запись имеет к нему доступ.',
                'toast.groupNotSpecified': 'Не указан идентификатор группы',
                'toast.groupAlreadyAdded': 'Чат уже добавлен или произошла ошибка',
                'toast.groupNotFound': 'Чат не найден или произошла ошибка',
                'toast.groupAdded': 'Группа добавлена',
                'toast.groupDeleted': 'Группа удалена',
                'toast.intervalNotSpecified': 'Не указан интервал',
                'toast.invalidInterval': 'Неверный интервал',
                'toast.maxIntervalError': 'Максимальный интервал: 10080 минут (7 дней)',
                'toast.intervalSet': 'Интервал установлен',
                'toast.publicationStarted': 'Публикация запущена',
                'toast.schedulerStarted': 'Планировщик запущен',
                'toast.schedulerStopped': 'Планировщик остановлен',
                'toast.schedulerNotInitialized': 'Планировщик не инициализирован',
                'toast.postHandlerNotInitialized': 'Обработчик постов не инициализирован',
                'toast.postReloaded': 'Пост перезагружен',
                'toast.statusReset': 'Статус публикации сброшен',
                'publication.completed': 'Завершено',
                'publication.cancelled': 'Прервано',
                'publication.completedSuccess': 'Публикация завершена успешно!',
                'publication.completedWithErrors': 'Публикация завершена с ошибками',
                'publication.criticalError': 'Критическая ошибка',
                'publication.initialization': 'Инициализация',
                'publication.gettingGroups': 'Получение списка групп...',
                'publication.publishing': 'Публикация в {total} групп',
                'publication.publishingGroup': 'Публикация в группу {current}/{total}: {group}',
                'publication.groupSuccess': 'Группа {current}/{total}: {group} - успешно',
                'publication.groupError': 'Группа {current}/{total}: {group} - ошибка',
                'publication.waiting': 'Ожидание {seconds} секунд...',
                'publication.stopped': 'Публикация остановлена на группе {current}/{total}',
                'groups.noTitle': 'Без названия',
                'groups.never': 'Никогда',
                'groups.deleteConfirm': 'Вы уверены, что хотите удалить эту группу?',
                'history.title': 'История публикаций',
                'history.loading': 'Загрузка...',
                'history.empty': 'История пуста',
                'history.filters.status': 'Статус',
                'history.filters.search': 'Поиск',
                'history.filters.dateFrom': 'С даты',
                'history.filters.dateTo': 'По дату',
                'history.filters.apply': 'Применить',
                'history.table.time': 'Время',
                'history.table.group': 'Группа',
                'history.table.status': 'Статус',
                'history.table.retries': 'Попытки',
                'history.table.error': 'Ошибка',
                'history.prev': 'Назад',
                'history.next': 'Вперед',
                'history.clear': 'Очистить историю',
                'history.clearConfirm': 'Вы уверены, что хотите очистить историю публикаций?',
                'history.status.success': 'Успешно',
                'history.status.error': 'Ошибка',
                'statistics.title': 'Статистика публикаций',
                'statistics.total': 'Всего публикаций',
                'statistics.successful': 'Успешных',
                'statistics.failed': 'Неудачных',
                'statistics.successRate': 'Процент успеха',
                'statistics.topGroups': 'Топ групп',
                'statistics.dailyActivity': 'Активность по дням',
                'statistics.hourlyActivity': 'Активность по часам',
                'statistics.publications': 'Публикации',
                'statistics.noData': 'Нет данных',
                'statistics.filterFrom': 'С даты',
                'statistics.filterTo': 'По дату',
                'statistics.filterApply': 'Применить',
                'templates.title': 'Шаблоны постов',
                'templates.create': 'Создать шаблон',
                'templates.loading': 'Загрузка...',
                'templates.empty': 'Нет шаблонов',
                'templates.table.name': 'Название',
                'templates.table.content': 'Содержимое',
                'templates.table.status': 'Статус',
                'templates.table.actions': 'Действия',
                'templates.status.active': 'Активен',
                'templates.status.inactive': 'Неактивен',
                'templates.actions.edit': 'Редактировать',
                'templates.actions.activate': 'Активировать',
                'templates.actions.delete': 'Удалить',
                'templates.deleteConfirm': 'Вы уверены, что хотите удалить этот шаблон?',
                'templates.variables.title': 'Доступные переменные:',
                'templates.variables.date': 'текущая дата',
                'templates.variables.time': 'текущее время',
                'templates.variables.datetime': 'дата и время',
                'templates.variables.chatId': 'ID чата',
                'templates.variables.chatTitle': 'название чата',
                'templates.variables.random': 'случайное число (1-1000)',
                'templates.variables.randomRange': 'случайное число от min до max',
                'templates.form.name': 'Название',
                'templates.form.content': 'Содержимое',
                'templates.form.variablesHint': 'Используйте переменные в фигурных скобках, например: {date}, {chat_title}',
                'templates.form.preview': 'Предпросмотр',
                'templates.form.previewTitle': 'Предпросмотр:',
                'common.cancel': 'Отмена',
                'common.save': 'Сохранить',
                'preview.title': 'Предпросмотр поста',
                'preview.selectGroup': 'Выберите группу для предпросмотра:',
                'preview.testGroup': 'Тестовая группа',
                'preview.update': 'Обновить предпросмотр',
                'preview.author': 'Вы',
                'preview.loading': 'Загрузка...',
                'preview.info': 'Длина текста:',
                'preview.chars': 'символов',
                'preview.usingTemplate': 'Используется шаблон:',
                
                // Расписания
                'schedule.title': 'Расписание публикаций',
                'schedule.create': 'Создать расписание',
                'schedule.loading': 'Загрузка...',
                'schedule.empty': 'Нет расписаний',
                'schedule.active': 'Активно',
                'schedule.inactive': 'Неактивно',
                'schedule.minutes': 'минут',
                'schedule.created': 'Расписание создано',
                'schedule.updated': 'Расписание обновлено',
                'schedule.activated': 'Расписание активировано',
                'schedule.deleted': 'Расписание удалено',
                'schedule.confirmActivate': 'Активировать это расписание? Текущее активное расписание будет деактивировано.',
                'schedule.confirmDelete': 'Удалить это расписание?',
                'schedule.table.type': 'Тип',
                'schedule.table.details': 'Детали',
                'schedule.table.status': 'Статус',
                'schedule.table.created': 'Создано',
                'schedule.table.actions': 'Действия',
                'schedule.types.interval': 'Интервал',
                'schedule.types.time': 'Конкретное время',
                'schedule.types.days': 'Дни недели',
                'schedule.types.hours': 'Часовое окно',
                'schedule.form.type': 'Тип расписания',
                'schedule.form.intervalMinutes': 'Интервал (минуты)',
                'schedule.form.hour': 'Час',
                'schedule.form.minute': 'Минута',
                'schedule.form.days': 'Дни недели',
                'schedule.form.startHour': 'Начальный час',
                'schedule.form.endHour': 'Конечный час',
                'schedule.form.activate': 'Активировать сразу',
                'schedule.days.mon': 'Пн',
                'schedule.days.tue': 'Вт',
                'schedule.days.wed': 'Ср',
                'schedule.days.thu': 'Чт',
                'schedule.days.fri': 'Пт',
                'schedule.days.sat': 'Сб',
                'schedule.days.sun': 'Вс',
                'schedule.actions.activate': 'Активировать',
                'schedule.actions.delete': 'Удалить',
                'schedule.errors.invalidInterval': 'Неверный интервал',
                'schedule.errors.invalidTime': 'Неверное время',
                'schedule.errors.noDays': 'Выберите хотя бы один день недели',
                'schedule.errors.invalidHours': 'Неверное часовое окно',
                
                'status.unknown': 'Неизвестно',
                'error.unknown': 'Неизвестная ошибка',
                'error.unknownGroup': 'Неизвестно',
                'loading': 'Загрузка...',
                'unit.minutes': 'мин',
                'unit.hours': 'часов'
            },
            en: {
                'app.title': 'Post Publishing System',
                'connection.checking': 'Checking connection...',
                'connection.connected': 'Connected',
                'connection.disconnected': 'Disconnected',
                'status.groups': 'Groups',
                'status.interval': 'Interval',
                'status.scheduler': 'Scheduler',
                'status.nextPublication': 'Next Publication',
                'status.publication': 'Publication Status',
                'status.running': 'Running',
                'status.stopped': 'Stopped',
                'status.notActive': 'Not Active',
                'status.publishing': 'Publishing',
                'status.waiting': 'Waiting',
                'publication.details': 'Detailed Publication Status',
                'publication.currentStep': 'Current Step:',
                'publication.progress': 'Progress:',
                'publication.startTime': 'Start Time:',
                'publication.lastUpdate': 'Last Update:',
                'publication.errors': 'Errors:',
                'actions.quick': 'Quick Actions',
                'actions.publishNow': 'Publish Now',
                'actions.startScheduler': 'Start Scheduler',
                'actions.stop': 'Stop',
                'actions.reloadPost': 'Reload Post',
                'settings.title': 'Settings',
                'settings.interval': 'Publication Interval',
                'settings.set': 'Set',
                'settings.maxMinutes': 'Max: 10080 minutes (7 days). Min: 1 minute.',
                'groups.add': 'Add Group/Channel',
                'groups.input': 'Link, @username or ID',
                'groups.addButton': 'Add Group',
                'groups.list': 'Groups/Channels List',
                'groups.empty': 'No groups added',
                'groups.emptyDesc': 'Add a group or channel to get started',
                'groups.loading': 'Loading groups...',
                'groups.lastPost': 'Last publication:',
                'groups.delete': 'Delete group',
                'groups.deleteConfirm': 'Delete this group?',
                'groups.active': 'Active',
                'groups.disabled': 'Disabled',
                'groups.enable': 'Enable group',
                'groups.disable': 'Disable group',
                'groups.disabledSuccess': 'Group disabled',
                'groups.enabledSuccess': 'Group enabled',
                'toast.notification': 'Notification',
                'toast.enterGroup': 'Enter link, @username or group ID',
                'toast.maxInterval': 'Maximum interval: 10080 minutes (7 days)',
                'toast.invalidInterval': 'Enter a valid interval (greater than 0)',
                'toast.unknownUnit': 'Unknown unit',
                'toast.errorPublishing': 'Publishing error',
                'toast.errorStartScheduler': 'Error starting scheduler',
                'toast.errorStopScheduler': 'Error stopping scheduler',
                'toast.errorReloadPost': 'Error reloading post',
                'toast.errorAddGroup': 'Error adding group',
                'toast.errorToggleGroup': 'Error changing group status',
                'toast.errorSetInterval': 'Error setting interval',
                'toast.groupNotFound': 'Could not find chat. Make sure the chat exists and your account has access to it.',
                'toast.groupNotSpecified': 'Group identifier not specified',
                'toast.groupAlreadyAdded': 'Chat already added or an error occurred',
                'toast.groupNotFound': 'Chat not found or an error occurred',
                'toast.groupAdded': 'Group added',
                'toast.groupDeleted': 'Group deleted',
                'toast.intervalNotSpecified': 'Interval not specified',
                'toast.invalidInterval': 'Invalid interval',
                'toast.maxIntervalError': 'Maximum interval: 10080 minutes (7 days)',
                'toast.intervalSet': 'Interval set',
                'toast.publicationStarted': 'Publication started',
                'toast.schedulerStarted': 'Scheduler started',
                'toast.schedulerStopped': 'Scheduler stopped',
                'toast.schedulerNotInitialized': 'Scheduler not initialized',
                'toast.postHandlerNotInitialized': 'Post handler not initialized',
                'toast.postReloaded': 'Post reloaded',
                'toast.statusReset': 'Publication status reset',
                'publication.completed': 'Completed',
                'publication.cancelled': 'Cancelled',
                'publication.completedSuccess': 'Publication completed successfully!',
                'publication.completedWithErrors': 'Publication completed with errors',
                'publication.criticalError': 'Critical error',
                'publication.initialization': 'Initialization',
                'publication.gettingGroups': 'Getting groups list...',
                'publication.publishing': 'Publishing to {total} groups',
                'publication.publishingGroup': 'Publishing to group {current}/{total}: {group}',
                'publication.groupSuccess': 'Group {current}/{total}: {group} - success',
                'publication.groupError': 'Group {current}/{total}: {group} - error',
                'publication.waiting': 'Waiting {seconds} seconds...',
                'publication.stopped': 'Publication stopped at group {current}/{total}',
                'groups.noTitle': 'No title',
                'groups.never': 'Never',
                'groups.deleteConfirm': 'Are you sure you want to delete this group?',
                'history.title': 'Publication History',
                'history.loading': 'Loading...',
                'history.empty': 'History is empty',
                'history.filters.status': 'Status',
                'history.filters.search': 'Search',
                'history.filters.dateFrom': 'From date',
                'history.filters.dateTo': 'To date',
                'history.filters.apply': 'Apply',
                'history.table.time': 'Time',
                'history.table.group': 'Group',
                'history.table.status': 'Status',
                'history.table.retries': 'Retries',
                'history.table.error': 'Error',
                'history.prev': 'Previous',
                'history.next': 'Next',
                'history.clear': 'Clear History',
                'history.clearConfirm': 'Are you sure you want to clear publication history?',
                'history.status.success': 'Success',
                'history.status.error': 'Error',
                'statistics.title': 'Publication Statistics',
                'statistics.total': 'Total Publications',
                'statistics.successful': 'Successful',
                'statistics.failed': 'Failed',
                'statistics.successRate': 'Success Rate',
                'statistics.topGroups': 'Top Groups',
                'statistics.dailyActivity': 'Daily Activity',
                'statistics.hourlyActivity': 'Hourly Activity',
                'statistics.publications': 'Publications',
                'statistics.noData': 'No data',
                'statistics.filterFrom': 'From date',
                'statistics.filterTo': 'To date',
                'statistics.filterApply': 'Apply',
                'templates.title': 'Post Templates',
                'templates.create': 'Create Template',
                'templates.loading': 'Loading...',
                'templates.empty': 'No templates',
                'templates.table.name': 'Name',
                'templates.table.content': 'Content',
                'templates.table.status': 'Status',
                'templates.table.actions': 'Actions',
                'templates.status.active': 'Active',
                'templates.status.inactive': 'Inactive',
                'templates.actions.edit': 'Edit',
                'templates.actions.activate': 'Activate',
                'templates.actions.delete': 'Delete',
                'templates.deleteConfirm': 'Are you sure you want to delete this template?',
                'templates.variables.title': 'Available Variables:',
                'templates.variables.date': 'current date',
                'templates.variables.time': 'current time',
                'templates.variables.datetime': 'date and time',
                'templates.variables.chatId': 'chat ID',
                'templates.variables.chatTitle': 'chat title',
                'templates.variables.random': 'random number (1-1000)',
                'templates.variables.randomRange': 'random number from min to max',
                'templates.form.name': 'Name',
                'templates.form.content': 'Content',
                'templates.form.variablesHint': 'Use variables in curly braces, e.g.: {date}, {chat_title}',
                'templates.form.preview': 'Preview',
                'templates.form.previewTitle': 'Preview:',
                'common.cancel': 'Cancel',
                'common.save': 'Save',
                'preview.title': 'Post Preview',
                'preview.selectGroup': 'Select group for preview:',
                'preview.testGroup': 'Test Group',
                'preview.update': 'Update Preview',
                'preview.author': 'You',
                'preview.loading': 'Loading...',
                'preview.info': 'Text length:',
                'preview.chars': 'characters',
                'preview.usingTemplate': 'Using template:',
                
                // Schedules
                'schedule.title': 'Publication Schedule',
                'schedule.create': 'Create Schedule',
                'schedule.loading': 'Loading...',
                'schedule.empty': 'No schedules',
                'schedule.active': 'Active',
                'schedule.inactive': 'Inactive',
                'schedule.minutes': 'minutes',
                'schedule.created': 'Schedule created',
                'schedule.updated': 'Schedule updated',
                'schedule.activated': 'Schedule activated',
                'schedule.deleted': 'Schedule deleted',
                'schedule.confirmActivate': 'Activate this schedule? The current active schedule will be deactivated.',
                'schedule.confirmDelete': 'Delete this schedule?',
                'schedule.table.type': 'Type',
                'schedule.table.details': 'Details',
                'schedule.table.status': 'Status',
                'schedule.table.created': 'Created',
                'schedule.table.actions': 'Actions',
                'schedule.types.interval': 'Interval',
                'schedule.types.time': 'Specific Time',
                'schedule.types.days': 'Days of Week',
                'schedule.types.hours': 'Time Window',
                'schedule.form.type': 'Schedule Type',
                'schedule.form.intervalMinutes': 'Interval (minutes)',
                'schedule.form.hour': 'Hour',
                'schedule.form.minute': 'Minute',
                'schedule.form.days': 'Days of Week',
                'schedule.form.startHour': 'Start Hour',
                'schedule.form.endHour': 'End Hour',
                'schedule.form.activate': 'Activate Immediately',
                'schedule.days.mon': 'Mon',
                'schedule.days.tue': 'Tue',
                'schedule.days.wed': 'Wed',
                'schedule.days.thu': 'Thu',
                'schedule.days.fri': 'Fri',
                'schedule.days.sat': 'Sat',
                'schedule.days.sun': 'Sun',
                'schedule.actions.activate': 'Activate',
                'schedule.actions.delete': 'Delete',
                'schedule.errors.invalidInterval': 'Invalid interval',
                'schedule.errors.invalidTime': 'Invalid time',
                'schedule.errors.noDays': 'Select at least one day of week',
                'schedule.errors.invalidHours': 'Invalid time window',
                
                'status.unknown': 'Unknown',
                'error.unknown': 'Unknown error',
                'error.unknownGroup': 'Unknown',
                'loading': 'Loading...',
                'unit.minutes': 'min',
                'unit.hours': 'hours'
            }
        };

        // Глобальные переменные
        let statusInterval;
        let groupsInterval;
        let lastGroupsData = null; // Кэш последних данных групп
        let currentLanguage = localStorage.getItem('language') || 'ru';
        let currentTheme = localStorage.getItem('theme') || 'light';
        
        // История публикаций
        let historyPage = 1;
        const historyPageSize = 20;
        let historyFilters = {
            status: '',
            search: '',
            start_date: '',
            end_date: ''
        };

        // Функции для работы с темой и языком
        function toggleTheme() {
            const checkbox = document.getElementById('themeToggle');
            const themeIcon = document.getElementById('themeIcon');
            if (checkbox.checked) {
                currentTheme = 'dark';
                document.documentElement.setAttribute('data-theme', 'dark');
                if (themeIcon) {
                    themeIcon.className = 'fas fa-moon theme-icon';
                }
            } else {
                currentTheme = 'light';
                document.documentElement.setAttribute('data-theme', 'light');
                if (themeIcon) {
                    themeIcon.className = 'fas fa-sun theme-icon';
                }
            }
            localStorage.setItem('theme', currentTheme);
        }

        function setTheme(theme) {
            currentTheme = theme;
            const checkbox = document.getElementById('themeToggle');
            const themeIcon = document.getElementById('themeIcon');
            if (checkbox) {
                checkbox.checked = theme === 'dark';
            }
            if (themeIcon) {
                themeIcon.className = theme === 'dark' ? 'fas fa-moon theme-icon' : 'fas fa-sun theme-icon';
            }
            document.documentElement.setAttribute('data-theme', theme);
            localStorage.setItem('theme', theme);
        }

        function setLanguage(lang) {
            currentLanguage = lang;
            localStorage.setItem('language', lang);
            
            // Обновляем активную кнопку
            document.querySelectorAll('.language-switcher button').forEach(btn => {
                btn.classList.remove('active');
            });
            document.getElementById(`lang-${lang}`).classList.add('active');
            
            // Обновляем тексты
            document.querySelectorAll('[data-i18n]').forEach(element => {
                const key = element.getAttribute('data-i18n');
                if (translations[lang] && translations[lang][key]) {
                    element.textContent = translations[lang][key];
                }
            });
            
            // Обновляем тексты в динамически созданных элементах (например, в списке групп)
            document.querySelectorAll('[data-i18n-key]').forEach(element => {
                const key = element.getAttribute('data-i18n-key');
                if (translations[lang] && translations[lang][key]) {
                    element.textContent = translations[lang][key];
                }
            });
            
            // Обновляем опции select
            const intervalUnit = document.getElementById('intervalUnit');
            if (intervalUnit) {
                intervalUnit.querySelector('option[value="minutes"]').textContent = t('unit.minutes');
                intervalUnit.querySelector('option[value="hours"]').textContent = t('unit.hours');
            }
            
            // Обновляем динамические тексты
            updateDynamicTexts();
            
            // Немедленно обновляем статусы, которые могут изменяться
            const schedulerStatus = document.getElementById('schedulerStatus');
            if (schedulerStatus && schedulerStatus.textContent) {
                const currentStatus = schedulerStatus.textContent.trim();
                // Определяем текущий статус на основе класса или текста
                const isRunning = schedulerStatus.classList.contains('bg-success') || 
                                 currentStatus === 'Запущен' || 
                                 currentStatus === 'Running';
                schedulerStatus.textContent = isRunning ? t('status.running') : t('status.stopped');
            }
            
            // Обновляем статус публикации, если он есть
            const publicationStatus = document.getElementById('publicationStatus');
            if (publicationStatus && publicationStatus.textContent) {
                const currentPubStatus = publicationStatus.textContent.trim();
                if (currentPubStatus === 'Публикация' || currentPubStatus === 'Publishing') {
                    publicationStatus.textContent = t('status.publishing');
                } else if (currentPubStatus === 'Ожидание' || currentPubStatus === 'Waiting') {
                    publicationStatus.textContent = t('status.waiting');
                } else if (currentPubStatus === 'Неактивно' || currentPubStatus === 'Not Active') {
                    publicationStatus.textContent = t('status.notActive');
                }
            }
            
            // Обновляем динамические тексты
            updateDynamicTexts();
            
            // Принудительно обновляем статус для получения актуальных данных
            loadStatus();
        }

        function t(key) {
            return translations[currentLanguage][key] || key;
        }

        function updateDynamicTexts() {
            // Обновляем заголовок страницы
            const titleElement = document.querySelector('title[data-i18n]');
            if (titleElement) {
                const key = titleElement.getAttribute('data-i18n');
                if (translations[currentLanguage] && translations[currentLanguage][key]) {
                    titleElement.textContent = translations[currentLanguage][key];
                }
            }
            // Обновляем статусы, которые могут изменяться
            const telegramStatusText = document.getElementById('telegramStatusText');
            if (telegramStatusText) {
                // Это будет обновлено в updateStatus
            }
        }

        // Инициализация
        document.addEventListener('DOMContentLoaded', function() {
            // Применяем сохраненную тему
            setTheme(currentTheme);
            
            // Применяем сохраненный язык
            setLanguage(currentLanguage);
            
            loadStatus();
            loadGroups();
            
            // Автообновление статуса каждые 2 секунды
            setInterval(() => {
                loadStatus();
            }, 2000);
            
            // Обновляем статус каждые 5 секунд
            statusInterval = setInterval(loadStatus, 5000);
            // Обновляем группы реже - каждые 30 секунд (моргание исправлено через кэширование)
            groupsInterval = setInterval(loadGroups, 30000);
            
            // Обработчики событий
            setupEventListeners();
            
            // Инициализируем поле ввода интервала
            setTimeout(() => {
                const intervalInput = document.getElementById('intervalInput');
                const intervalUnit = document.getElementById('intervalUnit');
                if (intervalInput && (!intervalInput.value || intervalInput.value === '24')) {
                    intervalInput.value = 24;
                    if (intervalUnit) {
                        intervalUnit.value = 'hours';
                    }
                }
            }, 1000);
        });

        // Загрузка статуса
        async function loadStatus() {
            try {
                const response = await safeFetch('/api/status');
                const data = await response.json();
                
                if (response.ok) {
                    updateStatus(data);
                } else {
                    console.error('Ошибка загрузки статуса:', data.error);
                }
            } catch (error) {
                if (error.message !== 'Unauthorized') {
                    console.error('Ошибка загрузки статуса:', error);
                }
            }
        }
        
        // Обертка для fetch с обработкой ошибок аутентификации
        async function safeFetch(url, options = {}) {
            const response = await fetch(url, options);
            
            // Если получили 401, перенаправляем на страницу логина
            if (response.status === 401) {
                window.location.href = '/login';
                throw new Error('Unauthorized');
            }
            
            return response;
        }
        
        // Функция для обработки ошибок аутентификации
        function handleAuthError(response) {
            if (response.status === 401) {
                window.location.href = '/login';
                return true;
            }
            return false;
        }
        
        // Функция выхода
        async function logout() {
            try {
                const response = await fetch('/logout', {
                    method: 'POST'
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    window.location.href = '/login';
                } else {
                    showToast(data.error || 'Ошибка выхода', 'error');
                }
            } catch (error) {
                console.error('Ошибка выхода:', error);
                // Все равно перенаправляем на логин
                window.location.href = '/login';
            }
        }

        // Обновление статуса на странице
        function updateStatus(data) {
            // Telegram статус
            const telegramStatus = document.getElementById('telegramStatus');
            const telegramStatusText = document.getElementById('telegramStatusText');
            
            if (data.telegram_connected) {
                telegramStatus.className = 'telegram-status telegram-connected';
                telegramStatusText.textContent = t('connection.connected');
            } else {
                telegramStatus.className = 'telegram-status telegram-disconnected';
                telegramStatusText.textContent = t('connection.disconnected');
            }
            
            // Статистика
            document.getElementById('groupsCount').textContent = data.groups_count;
            
            // Форматируем интервал на клиенте с учетом языка
            const intervalElement = document.getElementById('interval');
            if (data.interval_minutes !== undefined) {
                const intervalMinutes = data.interval_minutes;
                let intervalText;
                if (currentLanguage === 'en') {
                    if (intervalMinutes < 60) {
                        intervalText = `${intervalMinutes} min`;
                    } else if (intervalMinutes === 60) {
                        intervalText = "1 hour";
                    } else {
                        const hours = Math.floor(intervalMinutes / 60);
                        const minutes = intervalMinutes % 60;
                        if (minutes > 0) {
                            intervalText = `${hours}h ${minutes}m`;
                        } else {
                            intervalText = `${hours} hours`;
                        }
                    }
                } else {
                    if (intervalMinutes < 60) {
                        intervalText = `${intervalMinutes} мин`;
                    } else if (intervalMinutes === 60) {
                        intervalText = "1 час";
                    } else {
                        const hours = Math.floor(intervalMinutes / 60);
                        const minutes = intervalMinutes % 60;
                        if (minutes > 0) {
                            intervalText = `${hours}ч ${minutes}м`;
                        } else {
                            intervalText = `${hours}ч`;
                        }
                    }
                }
                intervalElement.textContent = intervalText;
            } else {
                intervalElement.textContent = data.interval;
            }
            
            // Обновляем поля ввода интервала только если они пустые
            const intervalInput = document.getElementById('intervalInput');
            const intervalUnit = document.getElementById('intervalUnit');
            if (intervalInput && (!intervalInput.value || intervalInput.value === '24')) {
                const intervalMinutes = data.interval_minutes || 1440;
                if (intervalMinutes < 60) {
                    intervalInput.value = intervalMinutes;
                    intervalUnit.value = 'minutes';
                } else {
                    const hours = Math.floor(intervalMinutes / 60);
                    intervalInput.value = hours;
                    intervalUnit.value = 'hours';
                }
            }
            
            // Планировщик
            const schedulerStatus = document.getElementById('schedulerStatus');
            // Используем текущий язык для перевода статуса
            schedulerStatus.textContent = data.scheduler_status === 'Запущен' ? t('status.running') : t('status.stopped');
            schedulerStatus.className = 'badge ' + (data.scheduler_status === 'Запущен' ? 'bg-success' : 'bg-secondary');
            
            // Следующая публикация
            const nextRunElement = document.getElementById('nextRun');
            if (data.next_run) {
                nextRunElement.textContent = data.next_run;
            } else {
                nextRunElement.textContent = t('status.unknown');
            }
            
            // Статус публикации
            if (data.publication_status) {
                console.log('Publication status received:', data.publication_status);
                updatePublicationStatus(data.publication_status);
            } else {
                console.log('No publication status in data');
                updatePublicationStatus(null);
            }
        }
        
        // Обновление статуса публикации
        function updatePublicationStatus(publicationStatus) {
            console.log('updatePublicationStatus called with:', publicationStatus);
            
            if (!publicationStatus) {
                const statusElement = document.getElementById('publicationStatus');
                const panel = document.getElementById('publicationStatusPanel');
                
                if (statusElement) {
                    statusElement.textContent = t('status.notActive');
                    statusElement.className = 'badge bg-secondary';
                }
                if (panel) {
                    panel.style.display = 'none';
                }
                return;
            }
            
            const statusElement = document.getElementById('publicationStatus');
            const panel = document.getElementById('publicationStatusPanel');
            
            console.log('Status element found:', !!statusElement);
            console.log('Panel element found:', !!panel);
            
            if (!statusElement || !panel) {
                console.error('Publication status elements not found');
                return;
            }
            
            if (publicationStatus.is_publishing) {
                console.log('Setting publishing status');
                statusElement.textContent = t('status.publishing');
                statusElement.className = 'badge bg-warning';
                panel.style.display = 'block';
                
                // Обновляем детальную информацию
                const currentStepElement = document.getElementById('currentStep');
                if (currentStepElement) {
                    // Переводим текущий этап публикации
                    let stepText = publicationStatus.current_step || '-';
                    
                    // Переводим известные статусы
                    if (stepText === 'Завершено' || stepText === 'Completed') {
                        stepText = t('publication.completed');
                    } else if (stepText === 'Прервано' || stepText === 'Cancelled') {
                        stepText = t('publication.cancelled');
                    } else if (stepText === 'Публикация завершена успешно!' || stepText.includes('completed successfully')) {
                        stepText = t('publication.completedSuccess');
                    } else if (stepText.includes('завершена с ошибками') || stepText.includes('completed with errors')) {
                        stepText = t('publication.completedWithErrors');
                    } else if (stepText.includes('Критическая ошибка') || stepText.includes('Critical error')) {
                        stepText = t('publication.criticalError');
                    } else if (stepText === 'Инициализация' || stepText === 'Initialization') {
                        stepText = t('publication.initialization');
                    } else if (stepText.includes('Получение списка групп') || stepText.includes('Getting groups')) {
                        stepText = t('publication.gettingGroups');
                    } else if (stepText.includes('Публикация в') && stepText.includes('групп')) {
                        // Парсим "Публикация в 3 групп" или "Publishing to 3 groups"
                        const match = stepText.match(/(\d+)/);
                        if (match) {
                            stepText = t('publication.publishing').replace('{total}', match[1]);
                        }
                    } else if (stepText.includes('Ожидание') || stepText.includes('Waiting')) {
                        // Парсим "Ожидание 49 секунд..." или "Waiting 49 seconds..."
                        const match = stepText.match(/(\d+)/);
                        if (match) {
                            stepText = t('publication.waiting').replace('{seconds}', match[1]);
                        }
                    }
                    
                    currentStepElement.textContent = stepText;
                }
                
                // Прогресс
                const progressBar = document.getElementById('progressBar');
                const progressText = document.getElementById('progressText');
                
                if (progressBar && progressText) {
                    const progressPercent = publicationStatus.progress_percent || 0;
                    
                    progressBar.style.width = progressPercent + '%';
                    progressBar.className = 'progress-bar ' + (progressPercent === 100 ? 'bg-success' : 'bg-primary');
                    progressBar.setAttribute('aria-valuenow', progressPercent);
                    progressBar.setAttribute('aria-valuemin', 0);
                    progressBar.setAttribute('aria-valuemax', 100);
                    
                    const completed = publicationStatus.completed_groups || 0;
                    const total = publicationStatus.total_groups || 0;
                    progressText.textContent = `${progressPercent.toFixed(1)}% (${completed}/${total})`;
                    
                    console.log(`Progress updated: ${progressPercent}% (${completed}/${total})`);
                } else {
                    console.error('Progress elements not found');
                }
                
                // Время
                const startTimeElement = document.getElementById('startTime');
                const lastUpdateElement = document.getElementById('lastUpdate');
                
                if (startTimeElement) {
                    startTimeElement.textContent = publicationStatus.start_time_str || '-';
                }
                if (lastUpdateElement) {
                    lastUpdateElement.textContent = publicationStatus.last_update_str || '-';
                }
                
                // Ошибки
                const errorsSection = document.getElementById('errorsSection');
                const errorsList = document.getElementById('errorsList');
                
                if (errorsSection && errorsList) {
                    if (publicationStatus.errors && publicationStatus.errors.length > 0) {
                        errorsSection.style.display = 'block';
                        errorsList.innerHTML = '';
                        
                        publicationStatus.errors.forEach(error => {
                            const errorItem = document.createElement('div');
                            errorItem.className = 'list-group-item list-group-item-danger';
                            errorItem.innerHTML = `
                                <div class="d-flex w-100 justify-content-between align-items-start">
                                    <div>
                                        <h6 class="mb-1"><i class="fas fa-exclamation-circle me-2"></i>${error.group || t('error.unknownGroup')}</h6>
                                        <p class="mb-1">${error.error || t('error.unknown')}</p>
                                    </div>
                                    <small class="text-muted">${error.time ? new Date(error.time).toLocaleTimeString() : ''}</small>
                                </div>
                            `;
                            errorsList.appendChild(errorItem);
                        });
                    } else {
                        errorsSection.style.display = 'none';
                    }
                }
                
            } else {
                console.log('Setting non-publishing status');
                statusElement.textContent = t('status.waiting');
                statusElement.className = 'badge bg-success';
                panel.style.display = 'none';
            }
        }

        // Загрузка списка групп
        async function loadGroups() {
            try {
                const response = await safeFetch('/api/groups');
                const data = await response.json();
                
                if (response.ok) {
                    updateGroupsList(data);
                } else {
                    console.error('Ошибка загрузки групп:', data.error);
                }
            } catch (error) {
                if (error.message !== 'Unauthorized') {
                    console.error('Ошибка загрузки групп:', error);
                }
            }
        }

        // Обновление списка групп
        function updateGroupsList(groups) {
            const groupsList = document.getElementById('groupsList');
            
            // Проверяем, изменились ли данные
            const groupsString = JSON.stringify(groups.map(g => ({
                id: g.id,
                title: g.title,
                username: g.username,
                last_post: g.last_post,
                is_disabled: g.is_disabled
            })));
            
            if (lastGroupsData === groupsString) {
                // Данные не изменились, не обновляем DOM
                return;
            }
            
            // Сохраняем новые данные
            lastGroupsData = groupsString;
            
            if (groups.length === 0) {
                groupsList.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-inbox"></i>
                        <p>${t('groups.empty')}</p>
                        <small>${t('groups.emptyDesc')}</small>
                    </div>
                `;
                return;
            }
            
            let html = '';
            groups.forEach((group, index) => {
                const isDisabled = group.is_disabled === true || group.is_disabled === 1;
                const statusBadge = isDisabled 
                    ? `<span class="badge bg-danger ms-2"><i class="fas fa-ban me-1"></i>${t('groups.disabled')}</span>`
                    : `<span class="badge bg-success ms-2"><i class="fas fa-check me-1"></i>${t('groups.active')}</span>`;
                
                html += `
                    <div class="group-item fade-in ${isDisabled ? 'disabled-group' : ''}" style="animation-delay: ${index * 0.1}s">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="flex-grow-1">
                                    <h6 class="mb-2">
                                    <i class="fas fa-users me-2 text-primary"></i>${group.title || t('groups.noTitle')}${statusBadge}
                                </h6>
                                <div class="d-flex flex-wrap gap-3 mb-2">
                                    <small class="text-muted">
                                        <i class="fas fa-hashtag me-1"></i>ID: ${group.id}
                                    </small>
                                    ${group.username ? `<small class="text-muted"><i class="fas fa-at me-1"></i>${group.username}</small>` : ''}
                                </div>
                                <small class="text-muted d-block">
                                    <i class="fas fa-clock me-1"></i><span data-i18n-key="groups.lastPost">${t('groups.lastPost')}</span> <strong>${group.last_post || t('groups.never')}</strong>
                                </small>
                            </div>
                            <div class="d-flex gap-2">
                                <button class="btn btn-sm ${isDisabled ? 'btn-success' : 'btn-warning'}" 
                                        onclick="toggleGroupDisabled('${group.id}', ${!isDisabled})" 
                                        title="${isDisabled ? t('groups.enable') : t('groups.disable')}">
                                    <i class="fas ${isDisabled ? 'fa-check' : 'fa-ban'}"></i>
                                </button>
                                <button class="btn btn-outline-danger btn-sm" onclick="removeGroup('${group.id}')" title="${t('groups.delete')}">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            groupsList.innerHTML = html;
        }

        // Настройка обработчиков событий
        function setupEventListeners() {
            // Добавление группы
            document.getElementById('addGroupBtn').addEventListener('click', addGroup);
            
            // Установка интервала
            const setIntervalBtn = document.getElementById('setIntervalBtn');
            if (setIntervalBtn) {
                setIntervalBtn.addEventListener('click', setIntervalValue);
            }
            
            // Быстрые действия
            document.getElementById('postNowBtn').addEventListener('click', postNow);
            document.getElementById('startSchedulerBtn').addEventListener('click', startScheduler);
            document.getElementById('stopSchedulerBtn').addEventListener('click', stopScheduler);
            document.getElementById('reloadPostBtn').addEventListener('click', reloadPost);

            // Enter в поле добавления группы
            document.getElementById('groupInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    addGroup();
                }
            });
            
            // Шаблоны
            document.getElementById('createTemplateBtn').addEventListener('click', () => {
                resetTemplateForm();
            });
            document.getElementById('saveTemplateBtn').addEventListener('click', saveTemplate);
            document.getElementById('previewTemplateBtn').addEventListener('click', previewTemplate);
            
            // Расписания
            document.getElementById('scheduleType').addEventListener('change', updateScheduleTypeFields);
            document.getElementById('saveScheduleBtn').addEventListener('click', saveSchedule);
            document.getElementById('scheduleModal').addEventListener('show.bs.modal', resetScheduleForm);
            
            // Предпросмотр поста
            document.getElementById('updatePreviewBtn').addEventListener('click', updatePostPreview);
            
            // Загружаем шаблоны, расписания и предпросмотр при загрузке страницы
            loadTemplates();
            loadSchedules();
            loadPostPreview();
            loadGroupsForPreview();
        }

        // Добавление группы
        async function addGroup() {
            const groupInput = document.getElementById('groupInput');
            const addBtn = document.getElementById('addGroupBtn');
            
            if (!groupInput.value.trim()) {
                showToast(t('toast.enterGroup'), 'warning');
                return;
            }
            
            setButtonLoading(addBtn, true);
            
            try {
                const response = await safeFetch('/api/groups', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        group_input: groupInput.value.trim()
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    showToast(data.message, 'success');
                    groupInput.value = '';
                    // Сбрасываем кэш, чтобы принудительно обновить список
                    lastGroupsData = null;
                    loadGroups();
                    loadStatus();
                } else {
                    showToast(data.error, 'error');
                }
            } catch (error) {
                if (error.message !== 'Unauthorized') {
                    showToast(t('toast.errorAddGroup'), 'error');
                }
            } finally {
                setButtonLoading(addBtn, false);
            }
        }

        // Удаление группы
        async function toggleGroupDisabled(chatId, isDisabled) {
            try {
                const response = await safeFetch(`/api/groups/${chatId}/toggle-disabled`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ is_disabled: isDisabled })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showToast(data.message || (isDisabled ? t('groups.disabledSuccess') : t('groups.enabledSuccess')), 'success');
                    lastGroupsData = null; // Принудительно обновляем список
                    loadGroups();
                } else {
                    showToast(data.error || t('toast.errorToggleGroup'), 'error');
                }
            } catch (error) {
                console.error('Ошибка изменения статуса группы:', error);
                showToast(t('toast.errorToggleGroup'), 'error');
            }
        }

        async function removeGroup(chatId) {
            if (!confirm(t('groups.deleteConfirm'))) {
                return;
            }
            
            try {
                const response = await safeFetch(`/api/groups/${chatId}`, {
                    method: 'DELETE'
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    showToast(data.message, 'success');
                    // Сбрасываем кэш, чтобы принудительно обновить список
                    lastGroupsData = null;
                    loadGroups();
                    loadStatus();
                } else {
                    showToast(data.error, 'error');
                }
            } catch (error) {
                if (error.message !== 'Unauthorized') {
                    showToast(t('toast.errorDeleteGroup'), 'error');
                }
            }
        }

        // Установка интервала
        async function setIntervalValue() {
            const intervalInput = document.getElementById('intervalInput');
            const intervalUnit = document.getElementById('intervalUnit');
            const setBtn = document.getElementById('setIntervalBtn');
            
            const value = parseInt(intervalInput.value);
            const unit = intervalUnit.value;
            
            if (!value || value <= 0) {
                showToast(t('toast.invalidInterval'), 'warning');
                return;
            }
            
            // Дополнительная валидация
            if (value > 10080) {
                showToast(t('toast.maxInterval'), 'warning');
                return;
            }
            
            // Конвертируем в минуты
            let minutes;
            if (unit === 'hours') {
                minutes = value * 60;
            } else if (unit === 'minutes') {
                minutes = value;
            } else {
                showToast(t('toast.unknownUnit'), 'error');
                return;
            }
            
            setButtonLoading(setBtn, true);
            
            try {
                const response = await safeFetch('/api/interval', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        minutes: minutes
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    showToast(data.message, 'success');
                    document.getElementById('interval').textContent = data.interval || minutes;
                    loadStatus();
                } else {
                    showToast(data.error, 'error');
                }
            } catch (error) {
                showToast(t('toast.errorSetInterval'), 'error');
            } finally {
                setButtonLoading(setBtn, false);
            }
        }

        // Публикация сейчас
        async function postNow() {
            const btn = document.getElementById('postNowBtn');
            setButtonLoading(btn, true);
            
            try {
                const response = await safeFetch('/api/post_now', {
                    method: 'POST'
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    showToast(data.message, 'success');
                } else {
                    showToast(data.error, 'error');
                }
            } catch (error) {
                showToast(t('toast.errorPublishing'), 'error');
            } finally {
                setButtonLoading(btn, false);
            }
        }

        // Запуск планировщика
        async function startScheduler() {
            const btn = document.getElementById('startSchedulerBtn');
            setButtonLoading(btn, true);
            
            try {
                const response = await safeFetch('/api/scheduler/start', {
                    method: 'POST'
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    showToast(data.message, 'success');
                    loadStatus();
                } else {
                    showToast(data.error, 'error');
                }
            } catch (error) {
                showToast(t('toast.errorStartScheduler'), 'error');
            } finally {
                setButtonLoading(btn, false);
            }
        }

        // Остановка планировщика
        async function stopScheduler() {
            const btn = document.getElementById('stopSchedulerBtn');
            setButtonLoading(btn, true);
            
            try {
                const response = await safeFetch('/api/scheduler/stop', {
                    method: 'POST'
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    showToast(data.message, 'success');
                    loadStatus();
                } else {
                    showToast(data.error, 'error');
                }
            } catch (error) {
                showToast(t('toast.errorStopScheduler'), 'error');
            } finally {
                setButtonLoading(btn, false);
            }
        }

        // Перезагрузка поста
        async function reloadPost() {
            const btn = document.getElementById('reloadPostBtn');
            setButtonLoading(btn, true);
            
            try {
                const response = await safeFetch('/api/reload_post', {
                    method: 'POST'
                });
                
                const data = await response.json();
                console.log('Reload post response:', data);
                
                if (response.ok && data.success) {
                    showToast(data.message, 'success');
                    console.log('Post reloaded successfully:', data.post_info);
                } else {
                    const errorMsg = data.error || 'Ошибка перезагрузки поста';
                    console.error('Reload post error:', errorMsg);
                    showToast(errorMsg, 'error');
                }
            } catch (error) {
                console.error('Reload post exception:', error);
                showToast(t('toast.errorReloadPost'), 'error');
            } finally {
                setButtonLoading(btn, false);
            }
        }

        async function loadHistory() {
            const tbody = document.getElementById('historyTableBody');
            tbody.innerHTML = '<tr><td colspan="5" class="text-center"><i class="fas fa-spinner fa-spin"></i> ' + t('history.loading') + '</td></tr>';
            
            try {
                const params = new URLSearchParams({
                    limit: historyPageSize,
                    offset: (historyPage - 1) * historyPageSize
                });
                
                if (historyFilters.status) params.append('status', historyFilters.status);
                if (historyFilters.search) params.append('search', historyFilters.search);
                if (historyFilters.start_date) params.append('start_date', historyFilters.start_date + ' 00:00:00');
                if (historyFilters.end_date) params.append('end_date', historyFilters.end_date + ' 23:59:59');
                
                const response = await safeFetch(`/api/publication_history?${params.toString()}`);
                const data = await response.json();
                
                if (response.ok && data.success) {
                    if (data.history.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="5" class="text-center">' + t('history.empty') + '</td></tr>';
                    } else {
                        tbody.innerHTML = data.history.map(record => {
                            const statusBadge = record.status === 'success' 
                                ? '<span class="badge bg-success">' + t('history.status.success') + '</span>'
                                : '<span class="badge bg-danger">' + t('history.status.error') + '</span>';
                            
                            return `
                                <tr>
                                    <td>${record.published_at}</td>
                                    <td>${record.chat_title || record.chat_username || record.chat_id}</td>
                                    <td>${statusBadge}</td>
                                    <td>${record.retry_count}</td>
                                    <td>${record.error_message || '-'}</td>
                                </tr>
                            `;
                        }).join('');
                    }
                    
                    // Обновляем пагинацию
                    const hasMore = data.history.length === historyPageSize;
                    document.getElementById('historyPrevBtn').disabled = historyPage === 1;
                    document.getElementById('historyNextBtn').disabled = !hasMore;
                    document.getElementById('historyPageInfo').textContent = `${historyPage} / ${hasMore ? historyPage + 1 : historyPage}`;
                } else {
                    tbody.innerHTML = '<tr><td colspan="5" class="text-center text-danger">' + (data.error || t('error.unknown')) + '</td></tr>';
                }
            } catch (error) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center text-danger">' + t('error.unknown') + '</td></tr>';
            }
        }

        function clearHistory() {
            if (!confirm(t('history.clearConfirm'))) {
                return;
            }
            
            safeFetch('/api/publication_history/clear', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({})
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showToast(data.message, 'success');
                    historyPage = 1;
                    loadHistory();
                } else {
                    showToast(data.error || t('error.unknown'), 'error');
                }
            })
            .catch(error => {
                showToast(t('error.unknown'), 'error');
            });
        }

        // Обновление фильтров истории
        document.getElementById('historyFilterBtn').addEventListener('click', function() {
            historyFilters = {
                status: document.getElementById('historyStatusFilter').value,
                search: document.getElementById('historySearchFilter').value,
                start_date: document.getElementById('historyDateFromFilter').value,
                end_date: document.getElementById('historyDateToFilter').value
            };
            historyPage = 1;
            loadHistory();
        });

        // Статистика и графики
        let dailyChart = null;
        let successRateChart = null;
        let hourlyChart = null;
        let topGroupsChart = null;

        async function loadStatistics() {
            try {
                const params = new URLSearchParams();
                const dateFrom = document.getElementById('statDateFrom').value;
                const dateTo = document.getElementById('statDateTo').value;
                
                if (dateFrom) params.append('start_date', dateFrom + ' 00:00:00');
                if (dateTo) params.append('end_date', dateTo + ' 23:59:59');
                
                const response = await safeFetch(`/api/publication_statistics?${params.toString()}`);
                const data = await response.json();
                
                if (response.ok && data.success) {
                    const stats = data.statistics;
                    
                    // Обновляем карточки статистики
                    document.getElementById('statTotal').textContent = stats.total || 0;
                    document.getElementById('statSuccessful').textContent = stats.successful || 0;
                    document.getElementById('statFailed').textContent = stats.failed || 0;
                    document.getElementById('statSuccessRate').textContent = (stats.success_rate || 0) + '%';
                    
                    // Обновляем графики
                    updateDailyChart(stats.daily_stats || []);
                    updateSuccessRateChart(stats.successful || 0, stats.failed || 0);
                    updateHourlyChart(stats.hourly_stats || []);
                    updateTopGroupsChart(stats.top_groups || []);
                }
            } catch (error) {
                console.error('Error loading statistics:', error);
            }
        }

        function updateDailyChart(dailyStats) {
            const ctx = document.getElementById('dailyChart').getContext('2d');
            
            // Подготавливаем данные (переворачиваем для показа от старых к новым)
            const reversed = [...dailyStats].reverse();
            const labels = reversed.map(d => {
                const date = new Date(d.date + 'T00:00:00');
                return date.toLocaleDateString(currentLanguage === 'ru' ? 'ru-RU' : 'en-US', { 
                    month: 'short', 
                    day: 'numeric' 
                });
            });
            const successfulData = reversed.map(d => d.successful || 0);
            const failedData = reversed.map(d => d.failed || 0);
            
            if (dailyChart) {
                dailyChart.destroy();
            }
            
            dailyChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: t('statistics.successful'),
                        data: successfulData,
                        borderColor: 'rgb(40, 167, 69)',
                        backgroundColor: 'rgba(40, 167, 69, 0.1)',
                        tension: 0.4
                    }, {
                        label: t('statistics.failed'),
                        data: failedData,
                        borderColor: 'rgb(220, 53, 69)',
                        backgroundColor: 'rgba(220, 53, 69, 0.1)',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            position: 'top',
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        function updateSuccessRateChart(successful, failed) {
            const ctx = document.getElementById('successRateChart').getContext('2d');
            
            if (successRateChart) {
                successRateChart.destroy();
            }
            
            successRateChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: [t('statistics.successful'), t('statistics.failed')],
                    datasets: [{
                        data: [successful, failed],
                        backgroundColor: [
                            'rgb(40, 167, 69)',
                            'rgb(220, 53, 69)'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            position: 'bottom',
                        }
                    }
                }
            });
        }

        function updateHourlyChart(hourlyStats) {
            const ctx = document.getElementById('hourlyChart').getContext('2d');
            
            // Создаем массив для всех 24 часов
            const hourlyData = Array(24).fill(0);
            hourlyStats.forEach(h => {
                hourlyData[h.hour] = h.count || 0;
            });
            
            const labels = Array.from({length: 24}, (_, i) => i.toString().padStart(2, '0') + ':00');
            
            if (hourlyChart) {
                hourlyChart.destroy();
            }
            
            hourlyChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: t('statistics.publications'),
                        data: hourlyData,
                        backgroundColor: 'rgba(54, 162, 235, 0.5)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        function updateTopGroupsChart(topGroups) {
            const ctx = document.getElementById('topGroupsChart').getContext('2d');
            
            const labels = topGroups.map(g => g.title || g.chat_id || 'Unknown').slice(0, 10);
            const data = topGroups.map(g => g.count || 0).slice(0, 10);
            
            if (topGroupsChart) {
                topGroupsChart.destroy();
            }
            
            if (topGroups.length === 0) {
                ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
                ctx.font = '16px Arial';
                ctx.fillStyle = '#666';
                ctx.textAlign = 'center';
                ctx.fillText(t('statistics.noData'), ctx.canvas.width / 2, ctx.canvas.height / 2);
                return;
            }
            
            topGroupsChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: t('statistics.publications'),
                        data: data,
                        backgroundColor: 'rgba(153, 102, 255, 0.5)',
                        borderColor: 'rgba(153, 102, 255, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    indexAxis: 'y',
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        // Шаблоны постов
        async function loadTemplates() {
            const tbody = document.getElementById('templatesTableBody');
            tbody.innerHTML = '<tr><td colspan="4" class="text-center"><i class="fas fa-spinner fa-spin"></i> ' + t('templates.loading') + '</td></tr>';
            
            try {
                const response = await safeFetch('/api/templates');
                const data = await response.json();
                
                if (response.ok && data.success) {
                    if (data.templates.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="4" class="text-center">' + t('templates.empty') + '</td></tr>';
                    } else {
                        tbody.innerHTML = data.templates.map(template => {
                            const statusBadge = template.is_active 
                                ? '<span class="badge bg-success">' + t('templates.status.active') + '</span>'
                                : '<span class="badge bg-secondary">' + t('templates.status.inactive') + '</span>';
                            
                            const contentPreview = template.content.length > 50 
                                ? template.content.substring(0, 50) + '...' 
                                : template.content;
                            
                            return `
                                <tr>
                                    <td><strong>${template.name}</strong></td>
                                    <td><code>${contentPreview}</code></td>
                                    <td>${statusBadge}</td>
                                    <td>
                                        <button class="btn btn-sm btn-outline-primary me-1" onclick="editTemplate(${template.id}, '${template.name.replace(/'/g, "\\'")}', '${template.content.replace(/'/g, "\\'").replace(/\n/g, '\\n')}')">
                                            <i class="fas fa-edit"></i> ${t('templates.actions.edit')}
                                        </button>
                                        ${!template.is_active ? `
                                            <button class="btn btn-sm btn-outline-success me-1" onclick="activateTemplate(${template.id})">
                                                <i class="fas fa-check"></i> ${t('templates.actions.activate')}
                                            </button>
                                        ` : ''}
                                        <button class="btn btn-sm btn-outline-danger" onclick="deleteTemplate(${template.id})">
                                            <i class="fas fa-trash"></i> ${t('templates.actions.delete')}
                                        </button>
                                    </td>
                                </tr>
                            `;
                        }).join('');
                    }
                } else {
                    tbody.innerHTML = '<tr><td colspan="4" class="text-center text-danger">' + (data.error || t('error.unknown')) + '</td></tr>';
                }
            } catch (error) {
                tbody.innerHTML = '<tr><td colspan="4" class="text-center text-danger">' + t('error.unknown') + '</td></tr>';
            }
        }

        function resetTemplateForm() {
            document.getElementById('templateId').value = '';
            document.getElementById('templateName').value = '';
            document.getElementById('templateContent').value = '';
            document.getElementById('templatePreview').style.display = 'none';
            document.getElementById('templateModalTitle').textContent = t('templates.create');
        }

        function editTemplate(id, name, content) {
            document.getElementById('templateId').value = id;
            document.getElementById('templateName').value = name;
            document.getElementById('templateContent').value = content.replace(/\\n/g, '\n');
            document.getElementById('templateModalTitle').textContent = t('templates.actions.edit');
            const modal = new bootstrap.Modal(document.getElementById('templateModal'));
            modal.show();
        }

        async function saveTemplate() {
            const id = document.getElementById('templateId').value;
            const name = document.getElementById('templateName').value;
            const content = document.getElementById('templateContent').value;
            
            if (!name || !content) {
                showToast(t('templates.form.name') + ' и ' + t('templates.form.content') + ' обязательны', 'error');
                return;
            }
            
            try {
                let response;
                if (id) {
                    // Обновление
                    response = await safeFetch(`/api/templates/${id}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ name, content })
                    });
                } else {
                    // Создание
                    response = await safeFetch('/api/templates', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ name, content })
                    });
                }
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    showToast(data.message, 'success');
                    const modal = bootstrap.Modal.getInstance(document.getElementById('templateModal'));
                    modal.hide();
                    loadTemplates();
                } else {
                    showToast(data.error || t('error.unknown'), 'error');
                }
            } catch (error) {
                showToast(t('error.unknown'), 'error');
            }
        }

        async function activateTemplate(id) {
            try {
                const response = await safeFetch(`/api/templates/${id}/activate`, {
                    method: 'POST'
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    showToast(data.message, 'success');
                    loadTemplates();
                } else {
                    showToast(data.error || t('error.unknown'), 'error');
                }
            } catch (error) {
                showToast(t('error.unknown'), 'error');
            }
        }

        async function deleteTemplate(id) {
            if (!confirm(t('templates.deleteConfirm'))) {
                return;
            }
            
            try {
                const response = await safeFetch(`/api/templates/${id}`, {
                    method: 'DELETE'
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    showToast(data.message, 'success');
                    loadTemplates();
                } else {
                    showToast(data.error || t('error.unknown'), 'error');
                }
            } catch (error) {
                showToast(t('error.unknown'), 'error');
            }
        }

        async function previewTemplate() {
            const content = document.getElementById('templateContent').value;
            
            if (!content) {
                showToast(t('templates.form.content') + ' не может быть пустым', 'warning');
                return;
            }
            
            try {
                const response = await safeFetch('/api/templates/preview', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ content })
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    document.getElementById('templatePreviewContent').textContent = data.preview;
                    document.getElementById('templatePreview').style.display = 'block';
                } else {
                    showToast(data.error || t('error.unknown'), 'error');
                }
            } catch (error) {
                showToast(t('error.unknown'), 'error');
            }
        }

        // Расписания публикаций
        async function loadSchedules() {
            try {
                const response = await safeFetch('/api/schedules');
                const data = await response.json();
                
                if (response.ok && data.success) {
                    const schedulesList = document.getElementById('schedulesList');
                    
                    if (data.schedules.length === 0) {
                        schedulesList.innerHTML = `
                            <tr>
                                <td colspan="5" class="text-center text-muted">
                                    <i class="fas fa-calendar-alt"></i> <span data-i18n="schedule.empty">Нет расписаний</span>
                                </td>
                            </tr>
                        `;
                        return;
                    }
                    
                    schedulesList.innerHTML = data.schedules.map(schedule => {
                        const typeNames = {
                            'interval': t('schedule.types.interval'),
                            'time': t('schedule.types.time'),
                            'days': t('schedule.types.days'),
                            'hours': t('schedule.types.hours')
                        };
                        
                        let details = '';
                        const scheduleData = schedule.schedule_data;
                        
                        if (schedule.schedule_type === 'interval') {
                            const minutes = scheduleData.minutes || 1440;
                            if (minutes < 60) {
                                details = `${minutes} ${t('schedule.minutes')}`;
                            } else {
                                const hours = Math.floor(minutes / 60);
                                const mins = minutes % 60;
                                details = mins > 0 ? `${hours}ч ${mins}м` : `${hours}ч`;
                            }
                        } else if (schedule.schedule_type === 'time') {
                            const hour = String(scheduleData.hour || 12).padStart(2, '0');
                            const minute = String(scheduleData.minute || 0).padStart(2, '0');
                            details = `${hour}:${minute}`;
                        } else if (schedule.schedule_type === 'days') {
                            const dayNames = [t('schedule.days.mon'), t('schedule.days.tue'), t('schedule.days.wed'), t('schedule.days.thu'), t('schedule.days.fri'), t('schedule.days.sat'), t('schedule.days.sun')];
                            const days = scheduleData.days || [];
                            const dayList = days.map(d => dayNames[d]).join(', ');
                            const hour = String(scheduleData.hour || 12).padStart(2, '0');
                            const minute = String(scheduleData.minute || 0).padStart(2, '0');
                            details = `${dayList} в ${hour}:${minute}`;
                        } else if (schedule.schedule_type === 'hours') {
                            const startHour = String(scheduleData.start_hour || 9).padStart(2, '0');
                            const endHour = String(scheduleData.end_hour || 18).padStart(2, '0');
                            const interval = scheduleData.interval_minutes || 60;
                            details = `${startHour}:00 - ${endHour}:00 (${interval} ${t('schedule.minutes')})`;
                        }
                        
                        return `
                            <tr>
                                <td>${typeNames[schedule.schedule_type] || schedule.schedule_type}</td>
                                <td>${details}</td>
                                <td>
                                    ${schedule.is_active 
                                        ? '<span class="badge bg-success">' + t('schedule.active') + '</span>' 
                                        : '<span class="badge bg-secondary">' + t('schedule.inactive') + '</span>'}
                                </td>
                                <td>${schedule.created_at}</td>
                                <td>
                                    ${!schedule.is_active 
                                        ? `<button class="btn btn-sm btn-success" onclick="activateSchedule(${schedule.id})">
                                            <i class="fas fa-check"></i> <span data-i18n="schedule.actions.activate">Активировать</span>
                                           </button>` 
                                        : ''}
                                    <button class="btn btn-sm btn-danger" onclick="deleteSchedule(${schedule.id})">
                                        <i class="fas fa-trash"></i> <span data-i18n="schedule.actions.delete">Удалить</span>
                                    </button>
                                </td>
                            </tr>
                        `;
                    }).join('');
                    
                    // Обновляем переводы
                    updateDynamicTexts();
                } else {
                    document.getElementById('schedulesList').innerHTML = `
                        <tr>
                            <td colspan="5" class="text-center text-danger">
                                ${data.error || t('error.unknown')}
                            </td>
                        </tr>
                    `;
                }
            } catch (error) {
                document.getElementById('schedulesList').innerHTML = `
                    <tr>
                        <td colspan="5" class="text-center text-danger">
                            ${t('error.unknown')}
                        </td>
                    </tr>
                `;
            }
        }
        
        function resetScheduleForm() {
            document.getElementById('scheduleId').value = '';
            document.getElementById('scheduleType').value = 'interval';
            document.getElementById('intervalMinutes').value = '1440';
            document.getElementById('timeHour').value = '12';
            document.getElementById('timeMinute').value = '0';
            document.getElementById('daysHour').value = '12';
            document.getElementById('daysMinute').value = '0';
            document.getElementById('hoursStart').value = '9';
            document.getElementById('hoursEnd').value = '18';
            document.getElementById('hoursInterval').value = '60';
            document.getElementById('scheduleActive').checked = false;
            
            // Сбрасываем чекбоксы дней недели
            document.querySelectorAll('.schedule-day-checkbox').forEach(cb => cb.checked = false);
            
            // Показываем правильные поля
            updateScheduleTypeFields();
        }
        
        function updateScheduleTypeFields() {
            const type = document.getElementById('scheduleType').value;
            
            // Скрываем все поля
            document.querySelectorAll('.schedule-type-fields').forEach(field => {
                field.style.display = 'none';
            });
            
            // Показываем нужные поля
            if (type === 'interval') {
                document.getElementById('scheduleIntervalFields').style.display = 'block';
            } else if (type === 'time') {
                document.getElementById('scheduleTimeFields').style.display = 'block';
            } else if (type === 'days') {
                document.getElementById('scheduleDaysFields').style.display = 'block';
            } else if (type === 'hours') {
                document.getElementById('scheduleHoursFields').style.display = 'block';
            }
        }
        
        async function saveSchedule() {
            const id = document.getElementById('scheduleId').value;
            const type = document.getElementById('scheduleType').value;
            const isActive = document.getElementById('scheduleActive').checked;
            
            let scheduleData = {};
            
            if (type === 'interval') {
                const minutes = parseInt(document.getElementById('intervalMinutes').value);
                if (!minutes || minutes < 1) {
                    showToast(t('schedule.errors.invalidInterval'), 'error');
                    return;
                }
                scheduleData = { minutes };
            } else if (type === 'time') {
                const hour = parseInt(document.getElementById('timeHour').value);
                const minute = parseInt(document.getElementById('timeMinute').value);
                if (hour < 0 || hour > 23 || minute < 0 || minute > 59) {
                    showToast(t('schedule.errors.invalidTime'), 'error');
                    return;
                }
                scheduleData = { hour, minute };
            } else if (type === 'days') {
                const days = Array.from(document.querySelectorAll('.schedule-day-checkbox:checked')).map(cb => parseInt(cb.value));
                if (days.length === 0) {
                    showToast(t('schedule.errors.noDays'), 'error');
                    return;
                }
                const hour = parseInt(document.getElementById('daysHour').value);
                const minute = parseInt(document.getElementById('daysMinute').value);
                if (hour < 0 || hour > 23 || minute < 0 || minute > 59) {
                    showToast(t('schedule.errors.invalidTime'), 'error');
                    return;
                }
                scheduleData = { days, hour, minute };
            } else if (type === 'hours') {
                const startHour = parseInt(document.getElementById('hoursStart').value);
                const endHour = parseInt(document.getElementById('hoursEnd').value);
                const intervalMinutes = parseInt(document.getElementById('hoursInterval').value);
                if (startHour < 0 || startHour > 23 || endHour < 0 || endHour > 23 || startHour >= endHour) {
                    showToast(t('schedule.errors.invalidHours'), 'error');
                    return;
                }
                if (intervalMinutes < 1 || intervalMinutes > 1440) {
                    showToast(t('schedule.errors.invalidInterval'), 'error');
                    return;
                }
                scheduleData = { start_hour: startHour, end_hour: endHour, interval_minutes: intervalMinutes };
            }
            
            try {
                let response;
                if (id) {
                    // Обновление
                    response = await safeFetch(`/api/schedules/${id}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            schedule_type: type,
                            schedule_data: scheduleData
                        })
                    });
                } else {
                    // Создание
                    response = await safeFetch('/api/schedules', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            schedule_type: type,
                            schedule_data: scheduleData,
                            is_active: isActive
                        })
                    });
                }
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    showToast(data.message || (id ? t('schedule.updated') : t('schedule.created')), 'success');
                    const modal = bootstrap.Modal.getInstance(document.getElementById('scheduleModal'));
                    modal.hide();
                    loadSchedules();
                    loadStatus(); // Обновляем статус планировщика
                } else {
                    showToast(data.error || t('error.unknown'), 'error');
                }
            } catch (error) {
                showToast(t('error.unknown'), 'error');
            }
        }
        
        async function activateSchedule(id) {
            if (!confirm(t('schedule.confirmActivate'))) {
                return;
            }
            
            try {
                const response = await safeFetch(`/api/schedules/${id}/activate`, {
                    method: 'POST'
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    showToast(data.message || t('schedule.activated'), 'success');
                    loadSchedules();
                    loadStatus(); // Обновляем статус планировщика
                } else {
                    showToast(data.error || t('error.unknown'), 'error');
                }
            } catch (error) {
                showToast(t('error.unknown'), 'error');
            }
        }
        
        async function deleteSchedule(id) {
            if (!confirm(t('schedule.confirmDelete'))) {
                return;
            }
            
            try {
                const response = await safeFetch(`/api/schedules/${id}`, {
                    method: 'DELETE'
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    showToast(data.message || t('schedule.deleted'), 'success');
                    loadSchedules();
                    loadStatus(); // Обновляем статус планировщика
                } else {
                    showToast(data.error || t('error.unknown'), 'error');
                }
            } catch (error) {
                showToast(t('error.unknown'), 'error');
            }
        }

        // Предпросмотр поста
        async function loadPostPreview() {
            try {
                const response = await safeFetch('/api/post/info');
                const data = await response.json();
                
                if (response.ok && data.success) {
                    const post = data.post;
                    
                    // Обновляем текст
                    document.getElementById('previewText').innerHTML = formatTelegramText(post.text || '');
                    
                    // Обновляем изображение
                    const previewImage = document.getElementById('previewImage');
                    const previewImageElement = document.getElementById('previewImageElement');
                    if (post.has_image && post.image_url) {
                        // Проверяем, что URL действительно существует
                        previewImageElement.src = post.image_url;
                        previewImageElement.onerror = function() {
                            // Если изображение не загрузилось, скрываем его
                            previewImage.style.display = 'none';
                        };
                        previewImageElement.onload = function() {
                            // Показываем изображение только если оно успешно загрузилось
                            previewImage.style.display = 'block';
                        };
                        previewImage.style.display = 'block';
                    } else {
                        previewImage.style.display = 'none';
                        previewImageElement.src = '';
                    }
                    
                    // Обновляем длину текста
                    document.getElementById('previewTextLength').textContent = post.text_length || 0;
                    
                    // Обновляем информацию о шаблоне
                    const templateInfo = document.getElementById('previewTemplateInfo');
                    const templateName = document.getElementById('previewTemplateName');
                    if (post.use_template && post.template_name) {
                        templateName.textContent = post.template_name;
                        templateInfo.style.display = 'inline';
                    } else {
                        templateInfo.style.display = 'none';
                    }
                    
                    // Обновляем время
                    const now = new Date();
                    document.getElementById('previewTime').textContent = now.toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });
                } else {
                    document.getElementById('previewText').innerHTML = '<span class="text-danger">' + (data.error || t('error.unknown')) + '</span>';
                }
            } catch (error) {
                document.getElementById('previewText').innerHTML = '<span class="text-danger">' + t('error.unknown') + '</span>';
            }
        }

        async function updatePostPreview() {
            const chatSelect = document.getElementById('previewChatSelect');
            const selectedOption = chatSelect.options[chatSelect.selectedIndex];
            const chatId = selectedOption.value || '123456789';
            const chatTitle = selectedOption.text || 'Тестовая группа';
            
            try {
                const response = await safeFetch('/api/post/preview', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        chat_id: chatId,
                        chat_title: chatTitle
                    })
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    const preview = data.preview;
                    
                    // Обновляем текст
                    document.getElementById('previewText').innerHTML = formatTelegramText(preview.text || '');
                    
                    // Обновляем изображение
                    const previewImage = document.getElementById('previewImage');
                    const previewImageElement = document.getElementById('previewImageElement');
                    if (preview.has_image && preview.image_url) {
                        previewImageElement.onerror = function() {
                            // Если изображение не загрузилось, скрываем его
                            previewImage.style.display = 'none';
                            previewImageElement.src = '';
                        };
                        previewImageElement.onload = function() {
                            // Показываем изображение только если оно успешно загрузилось
                            previewImage.style.display = 'block';
                        };
                        previewImageElement.src = preview.image_url;
                    } else {
                        previewImage.style.display = 'none';
                        previewImageElement.src = '';
                    }
                    
                    // Обновляем длину текста
                    document.getElementById('previewTextLength').textContent = preview.text ? preview.text.length : 0;
                    
                    // Обновляем время
                    const now = new Date();
                    document.getElementById('previewTime').textContent = now.toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });
                } else {
                    showToast(data.error || t('error.unknown'), 'error');
                }
            } catch (error) {
                showToast(t('error.unknown'), 'error');
            }
        }

        async function loadGroupsForPreview() {
            try {
                const response = await safeFetch('/api/groups');
                const data = await response.json();
                
                if (response.ok && Array.isArray(data)) {
                    const chatSelect = document.getElementById('previewChatSelect');
                    
                    // Очищаем существующие опции (кроме первой)
                    while (chatSelect.options.length > 1) {
                        chatSelect.remove(1);
                    }
                    
                    // Добавляем группы
                    data.forEach(group => {
                        const option = document.createElement('option');
                        option.value = group.id;
                        option.textContent = group.title || group.id;
                        option.setAttribute('data-title', group.title || '');
                        chatSelect.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Ошибка загрузки групп для предпросмотра:', error);
            }
        }

        function formatTelegramText(text) {
            if (!text) return '';
            
            // Заменяем HTML теги для безопасного отображения
            // Поддерживаем базовое форматирование: <b>, <i>, <code>, <a>
            let formatted = text
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/&lt;b&gt;(.*?)&lt;\/b&gt;/g, '<strong>$1</strong>')
                .replace(/&lt;i&gt;(.*?)&lt;\/i&gt;/g, '<em>$1</em>')
                .replace(/&lt;code&gt;(.*?)&lt;\/code&gt;/g, '<code>$1</code>')
                .replace(/&lt;a href="([^"]+)"&gt;(.*?)&lt;\/a&gt;/g, '<a href="$1" target="_blank">$2</a>')
                .replace(/\n/g, '<br>');
            
            return formatted;
        }

        // Утилиты
        function setButtonLoading(button, loading) {
            if (loading) {
                button.disabled = true;
                if (!button.getAttribute('data-original-text')) {
                    button.setAttribute('data-original-text', button.innerHTML);
                }
                const loadingText = t('loading');
                button.innerHTML = `<span class="spinner-border spinner-border-sm me-2"></span>${loadingText}`;
            } else {
                button.disabled = false;
                const originalText = button.getAttribute('data-original-text');
                if (originalText) {
                    button.innerHTML = originalText;
                    button.removeAttribute('data-original-text');
                    // Обновляем переводы в кнопке после восстановления
                    updateButtonTranslations(button);
                }
            }
        }

        function updateButtonTranslations(button) {
            // Обновляем переводы в кнопке после восстановления
            const i18nElements = button.querySelectorAll('[data-i18n]');
            i18nElements.forEach(element => {
                const key = element.getAttribute('data-i18n');
                if (translations[currentLanguage] && translations[currentLanguage][key]) {
                    element.textContent = translations[currentLanguage][key];
                }
            });
        }

        // Функция для перевода сообщений от API
        function translateApiMessage(message) {
            if (!message) return message;
            
            // Маппинг русских сообщений на ключи переводов
            const messageMap = {
                'Группа добавлена': 'toast.groupAdded',
                'Чат удален': 'toast.groupDeleted',
                'Чат {id} удален': 'toast.groupDeleted',
                'Интервал установлен': 'toast.intervalSet',
                'Публикация запущена': 'toast.publicationStarted',
                'Планировщик запущен': 'toast.schedulerStarted',
                'Планировщик остановлен': 'toast.schedulerStopped',
                'Пост перезагружен': 'toast.postReloaded',
                'Статус публикации сброшен': 'toast.statusReset',
                'Не указан идентификатор группы': 'toast.groupNotSpecified',
                'Не удалось найти чат': 'toast.groupNotFound',
                'Чат уже добавлен или произошла ошибка': 'toast.groupAlreadyAdded',
                'Чат не найден или произошла ошибка': 'toast.groupNotFound',
                'Не указан интервал': 'toast.intervalNotSpecified',
                'Неверный интервал': 'toast.invalidInterval',
                'Максимальный интервал: 10080 минут (7 дней)': 'toast.maxIntervalError',
                'Ошибка установки интервала': 'toast.errorSetInterval',
                'Планировщик не инициализирован': 'toast.schedulerNotInitialized',
                'Обработчик постов не инициализирован': 'toast.postHandlerNotInitialized'
            };
            
            // Проверяем, есть ли перевод для этого сообщения
            // Ищем точное совпадение или частичное (для динамических сообщений)
            for (const [key, translationKey] of Object.entries(messageMap)) {
                if (message.includes(key)) {
                    // Если язык английский, используем перевод
                    if (currentLanguage === 'en') {
                        return t(translationKey);
                    }
                    // Если язык русский, возвращаем как есть или используем перевод для единообразия
                    return currentLanguage === 'ru' ? message : t(translationKey);
                }
            }
            
            // Проверяем динамические сообщения (например, "Чат {id} удален")
            if (message.includes('Чат') && message.includes('удален')) {
                return currentLanguage === 'en' ? t('toast.groupDeleted') : message;
            }
            if (message.includes('Чат') && message.includes('добавлен')) {
                return currentLanguage === 'en' ? t('toast.groupAdded') : message;
            }
            if (message.includes('Интервал установлен')) {
                return currentLanguage === 'en' ? t('toast.intervalSet') : message;
            }
            
            return message;
        }

        function showToast(message, type = 'info') {
            const toast = document.getElementById('toast');
            const toastBody = document.getElementById('toastBody');
            const toastHeader = toast.querySelector('.toast-header i');
            const toastHeaderTitle = toast.querySelector('.toast-header strong');
            
            // Переводим сообщение если нужно
            const translatedMessage = translateApiMessage(message);
            toastBody.textContent = translatedMessage;
            if (toastHeaderTitle) {
                toastHeaderTitle.textContent = t('toast.notification');
            }
            
            // Устанавливаем цвет иконки
            toastHeader.className = 'fas me-2';
            switch (type) {
                case 'success':
                    toastHeader.classList.add('fa-check-circle', 'text-success');
                    break;
                case 'error':
                    toastHeader.classList.add('fa-exclamation-circle', 'text-danger');
                    break;
                case 'warning':
                    toastHeader.classList.add('fa-exclamation-triangle', 'text-warning');
                    break;
                default:
                    toastHeader.classList.add('fa-info-circle', 'text-primary');
            }
            
            const bsToast = new bootstrap.Toast(toast);
            bsToast.show();
        }
    </script>
</body>
</html>